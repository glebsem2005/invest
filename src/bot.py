import html
import logging
import re
import traceback
import json
import os
import smtplib
from abc import ABC, abstractmethod
from typing import Any, Dict, Tuple
from docx import Document
from docx.shared import Inches
import tempfile
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from email.mime.base import MIMEBase
from email import encoders

import aiogram.utils.exceptions
from aiogram import Bot, Dispatcher, executor, types
from aiogram.contrib.fsm_storage.memory import MemoryStorage
from aiogram.dispatcher import FSMContext
from aiogram.dispatcher.filters.state import State, StatesGroup

from access_middleware import AccessMiddleware
from chat_context import ChatContextManager
from config import Config
from file_processor import FileProcessor
from keyboards_builder import Button, DynamicKeyboard, Keyboard
from logger import Logger
from models_api import ExcelFileManager, ExcelSearchStrategy, ModelAPI
from prompts import DEFAULT_PROMPTS_DIR, Models, SystemPrompt, SystemPrompts, Topics

Logger()
logger = logging.getLogger('bot')
config = Config()

class EmailSender:
    """–ö–ª–∞—Å—Å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ email —Å –æ—Ç—á–µ—Ç–∞–º–∏."""
    
    def __init__(self):
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ email –∏–∑ config
        self.smtp_server = config.SMTP_SERVER
        self.smtp_port = config.SMTP_PORT  
        self.email_user = config.EMAIL_USER
        self.email_password = config.EMAIL_PASSWORD
        self.sender_name = config.SENDER_NAME
        
        if not self.email_user or not self.email_password:
            logger.warning("Email credentials not configured. Email sending will not work.")
    
def _sanitize_filename(self, filename: str) -> str:
    """–û—á–∏—â–∞–µ—Ç –∏–º—è —Ñ–∞–π–ª–∞ –æ—Ç –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤."""
    if not filename or not filename.strip():
        return 'unknown_company'
    
    # –£–±–∏—Ä–∞–µ–º –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã –¥–ª—è –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
    sanitized = re.sub(r'[<>:"/\\|?*\x00-\x1f]', '_', str(filename))
    # –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –≤ –Ω–∞—á–∞–ª–µ –∏ –∫–æ–Ω—Ü–µ
    sanitized = sanitized.strip()
    # –ó–∞–º–µ–Ω—è–µ–º –ø—Ä–æ–±–µ–ª—ã –Ω–∞ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è
    sanitized = sanitized.replace(' ', '_')
    # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É
    if len(sanitized) > 50:
        sanitized = sanitized[:50]
    # –£–±–∏—Ä–∞–µ–º —Ç–æ—á–∫–∏ –≤ –∫–æ–Ω—Ü–µ (–ø—Ä–æ–±–ª–µ–º—ã –≤ Windows)
    sanitized = sanitized.rstrip('.')
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ –ø—É—Å—Ç–æ–π
    if not sanitized:
        return 'unknown_company'
        
    return sanitized

async def send_report(self, recipient_email: str, company_name: str, report_file_path: str, filename: str = None) -> bool:
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç—á–µ—Ç –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π email."""
    if not self.email_user or not self.email_password:
        logger.error("Email credentials not configured")
        return False
        
    try:
        # –°–æ–∑–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        msg = MIMEMultipart()
        msg['From'] = f"{self.sender_name} <{self.email_user}>"
        msg['To'] = recipient_email
        msg['Subject'] = f"–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑: {company_name}"
        
        # –¢–µ–∫—Å—Ç –ø–∏—Å—å–º–∞
        body = f"""–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!

–í—ã—Å—ã–ª–∞–µ–º –≤–∞–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–º–ø–∞–Ω–∏–∏ "{company_name}".

–û—Ç—á–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç:
- –ê–Ω–∞–ª–∏–∑ —Ä—ã–Ω–∫–∞ –∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
- –û—Ü–µ–Ω–∫—É –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω–æ–π –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏  
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—é

–° —É–≤–∞–∂–µ–Ω–∏–µ–º,
–ö–æ–º–∞–Ω–¥–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–≤"""
        
        msg.attach(MIMEText(body, 'plain', 'utf-8'))
        
        # –ü—Ä–∏–∫—Ä–µ–ø–ª—è–µ–º —Ñ–∞–π–ª –æ—Ç—á–µ—Ç–∞
        if os.path.exists(report_file_path):
            with open(report_file_path, "rb") as attachment:
                part = MIMEBase('application', 'octet-stream')
                part.set_payload(attachment.read())
            
            encoders.encode_base64(part)
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞
            if filename:
                safe_filename = self._sanitize_filename(filename)
            else:
                safe_company_name = self._sanitize_filename(company_name)
                safe_filename = f"investment_analysis_{safe_company_name}.docx"
            
            # –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ –∏–º—è —Ñ–∞–π–ª–∞ –Ω–µ –ø—É—Å—Ç–æ–µ
            if not safe_filename:
                safe_filename = "investment_analysis_report.docx"
            
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –±–µ–∑ –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–±–µ–ª–æ–≤
            part.add_header(
                'Content-Disposition',
                f'attachment; filename="{safe_filename}"'
            )
            msg.attach(part)
            
            logger.info(f"Attached file with name: {safe_filename}")
        else:
            logger.error(f"Report file not found: {report_file_path}")
            return False
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º email
        server = smtplib.SMTP(self.smtp_server, self.smtp_port)
        server.starttls()
        server.login(self.email_user, self.email_password)
        text = msg.as_string()
        server.sendmail(self.email_user, recipient_email, text)
        server.quit()
        
        logger.info(f"Email successfully sent to {recipient_email}")
        return True
        
    except Exception as e:
        logger.error(f"Failed to send email to {recipient_email}: {e}")
        return False

class UserStates(StatesGroup):
    ACCESS = State()
    CHOOSING_TOPIC = State()  # –í—ã–±–æ—Ä —Ç–µ–º—ã –∞–Ω–∞–ª–∏–∑–∞
    CHOOSING_MODEL = State()  # –í—ã–±–æ—Ä –º–æ–¥–µ–ª–∏
    ENTERING_PROMPT = State()  # –í–≤–æ–¥ –∑–∞–ø—Ä–æ—Å–∞
    ATTACHING_FILE = State()  # –û–∂–∏–¥–∞–Ω–∏–µ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞
    UPLOADING_FILE = State()  # –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
    ASKING_CONTINUE = State()  # –°–ø—Ä–∞—à–∏–≤–∞–µ–º, –µ—Å—Ç—å –ª–∏ –µ—â–µ –≤–æ–ø—Ä–æ—Å—ã
    CONTINUE_DIALOG = State()  # –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞ —Å —Ç–æ–π –∂–µ –º–æ–¥–µ–ª—å—é –∏ —Ç–µ–º–æ–π
    ATTACHING_FILE_CONTINUE = State()  # –û–∂–∏–¥–∞–Ω–∏–µ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞ –ø—Ä–∏ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–∏ –¥–∏–∞–ª–æ–≥–∞
    UPLOADING_FILE_CONTINUE = State()  # –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –ø—Ä–∏ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–∏ –¥–∏–∞–ª–æ–≥–∞
    
    # –ù–æ–≤—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
    INVESTMENT_ACTIONS = State()  # –í—ã–±–æ—Ä –¥–µ–π—Å—Ç–≤–∏—è –ø–æ—Å–ª–µ executive summary
    INVESTMENT_QA = State()  # –†–µ–∂–∏–º –≤–æ–ø—Ä–æ—Å–æ–≤-–æ—Ç–≤–µ—Ç–æ–≤ –ø–æ –∞–Ω–∞–ª–∏–∑—É
    INVESTMENT_REPORT_OPTIONS = State()  # –í—ã–±–æ—Ä —Å–ø–æ—Å–æ–±–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç—á–µ—Ç–∞
    ENTERING_EMAIL = State()  # –í–≤–æ–¥ email –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç—á–µ—Ç–∞


class AdminStates(StatesGroup):
    """–°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π."""

    CHOOSING_PROMPT = State()  # –í—ã–±–æ—Ä –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    CHOOSING_PROMPT_TYPE = State()  # –í—ã–±–æ—Ä —Ç–∏–ø–∞ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (—Å–∏—Å—Ç–µ–º–Ω—ã–π, –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–ª–∏ –æ–±–∞)
    UPLOADING_SYSTEM_PROMPT = State()  # –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ —Å –Ω–æ–≤—ã–º —Å–∏—Å—Ç–µ–º–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º
    UPLOADING_DETAIL_PROMPT = State()  # –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ —Å –Ω–æ–≤—ã–º –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º
    UPLOADING_PROMPT = State()  # –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ —Å –Ω–æ–≤—ã–º –ø—Ä–æ–º–ø—Ç–æ–º (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
    NEW_PROMPT_NAME = State()  # –í–≤–æ–¥ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –∏–º–µ–Ω–∏ –Ω–æ–≤–æ–≥–æ —Ç–æ–ø–∏–∫–∞
    NEW_PROMPT_DISPLAY = State()  # –í–≤–æ–¥ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–≥–æ –∏–º–µ–Ω–∏ –Ω–æ–≤–æ–≥–æ —Ç–æ–ø–∏–∫–∞
    NEW_PROMPT_UPLOAD = State()  # –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ —Å —Å–∏—Å—Ç–µ–º–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º
    NEW_PROMPT_UPLOAD_DETAIL = State()  # –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ —Å –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º
    UPLOADING_SCOUTING_FILE = State()  # –ó–∞–≥—Ä—É–∑–∫–∞ excel —Ñ–∞–π–ª–∞ –¥–ª—è —Å–∫–∞—É—Ç–∏–Ω–≥–∞


class TopicKeyboard(DynamicKeyboard):
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–µ–º—ã."""

    @classmethod
    def get_buttons(cls) -> Tuple[Button, ...]:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–Ω–æ–ø–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–æ–ø–∏–∫–æ–≤."""
        buttons = []

        for topic_name, topic in Topics.__members__.items():
            buttons.append(Button(text=topic.value, callback=f'topic_{topic_name}'))

        return tuple(buttons)


class FileAttachKeyboard(DynamicKeyboard):
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞."""

    @classmethod
    def get_buttons(cls) -> Tuple[Button, ...]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–Ω–æ–ø–∫–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞."""
        return (
            Button(text='–î–∞, –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª', callback='attach_file'),
            Button(text='–ù–µ—Ç, –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –±–µ–∑ —Ñ–∞–π–ª–∞', callback='no_file'),
        )


class ContinueKeyboard(Keyboard):
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞."""

    _buttons = (
        Button('–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å', 'continue_yes'),
        Button('–ó–∞–≤–µ—Ä—à–∏—Ç—å —á–∞—Ç', 'continue_no'),
    )


class AuthorizeKeyboard(Keyboard):
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏."""

    _buttons = [Button('–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å', 'authorize_yes'), Button('–û—Ç–∫–ª–æ–Ω–∏—Ç—å', 'authorize_no')]


class AdminPromptKeyboard(DynamicKeyboard):
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø—Ä–æ–º–ø—Ç–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º."""

    @classmethod
    def get_buttons(cls) -> Tuple[Button, ...]:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–Ω–æ–ø–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–æ–≤."""
        buttons = []

        for topic_name, topic in Topics.__members__.items():
            buttons.append(Button(text=topic.value, callback=f'prompt_{topic_name}'))

        return tuple(buttons)


class PromptTypeKeyboard(Keyboard):
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –ø—Ä–æ–º–ø—Ç–∞ (—Å–∏—Å—Ç–µ–º–Ω—ã–π, –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–ª–∏ –æ–±–∞)."""

    _buttons = (
        Button('–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç', 'prompt_type_system'),
        Button('–î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç', 'prompt_type_detail'),
        Button('–û–±–∞ –ø—Ä–æ–º–ø—Ç–∞', 'prompt_type_both'),
    )


class InvestmentActionsKeyboard(Keyboard):
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è executive summary."""

    _buttons = (
        Button('üîÑ –†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è', 'investment_regenerate'),
        Button('‚ùì –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å', 'investment_ask_question'),
        Button('üìÑ –ü–æ–ª—É—á–∏—Ç—å –æ—Ç—á–µ—Ç', 'investment_get_report'),
    )


class InvestmentReportKeyboard(Keyboard):
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å–ø–æ—Å–æ–±–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç—á–µ—Ç–∞."""

    _buttons = (
        Button('üíæ –°–∫–∞—á–∞—Ç—å –æ—Ç—á–µ—Ç', 'investment_download'),
        Button('üìß –í—ã—Å–ª–∞—Ç—å –Ω–∞ –ø–æ—á—Ç—É', 'investment_email'),
        Button('‚Üê –ù–∞–∑–∞–¥', 'investment_back_to_actions'),
    )


class PromptTypeKeyboard(Keyboard):
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –ø—Ä–æ–º–ø—Ç–∞ (—Å–∏—Å—Ç–µ–º–Ω—ã–π, –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–ª–∏ –æ–±–∞)."""

    _buttons = (
        Button('–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç', 'prompt_type_system'),
        Button('–î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç', 'prompt_type_detail'),
        Button('–û–±–∞ –ø—Ä–æ–º–ø—Ç–∞', 'prompt_type_both'),
    )


class InvestmentAnalysisProcessor:
    """–ö–ª–∞—Å—Å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞–Ω–∞–ª–∏–∑–∞ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω–æ–π –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏."""
    
    def __init__(self):
        self.analysis_prompt = """
–ù–∞–π–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ –≤ —Ç–µ–∫—Å—Ç–µ –∏ –æ–ø—Ä–µ–¥–µ–ª–∏ —Ç–∏–ø—ã –∞–Ω–∞–ª–∏–∑–∞.

–ì–õ–ê–í–ù–ê–Ø –ó–ê–î–ê–ß–ê: —Ç–æ—á–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏.

–¢–µ–∫—Å—Ç: "{user_text}"

–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:
1. –ù–∞–π–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ –∏–ª–∏ –±—Ä–µ–Ω–¥–∞ –≤ —Ç–µ–∫—Å—Ç–µ
2. –ï—Å–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—è –Ω–µ—Ç, –Ω–æ –µ—Å—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ ("—Ñ—É–¥—Ç–µ—Ö —Å—Ç–∞—Ä—Ç–∞–ø"), –Ω–∞–ø–∏—à–∏ "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è_–∫–æ–º–ø–∞–Ω–∏—è"
3. –û–ø—Ä–µ–¥–µ–ª–∏ –Ω—É–∂–Ω—ã–µ –∞–Ω–∞–ª–∏–∑—ã:
   - market: 1 –µ—Å–ª–∏ –Ω—É–∂–µ–Ω —Ä—ã–Ω–æ—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑ (—Ä—ã–Ω–æ–∫, —Ñ–∏–Ω–∞–Ω—Å—ã, –ø–æ–∑–∏—Ü–∏—è)
   - rivals: 1 –µ—Å–ª–∏ –Ω—É–∂–µ–Ω –∞–Ω–∞–ª–∏–∑ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
   - synergy: 1 –µ—Å–ª–∏ –Ω—É–∂–µ–Ω –∞–Ω–∞–ª–∏–∑ —Å–∏–Ω–µ—Ä–≥–∏–∏
   - –ï—Å–ª–∏ —Ç–∏–ø –∞–Ω–∞–ª–∏–∑–∞ –Ω–µ —É–∫–∞–∑–∞–Ω, —Å—Ç–∞–≤—å –≤—Å–µ –≤ 1

–û—Ç–≤–µ—Ç —Ç–æ–ª—å–∫–æ JSON: {{"name": "–Ω–∞–∑–≤–∞–Ω–∏–µ", "market": 1, "rivals": 1, "synergy": 1}}

–ü—Ä–∏–º–µ—Ä—ã:
"–∞–Ω–∞–ª–∏–∑ Apple" ‚Üí {{"name": "Apple", "market": 1, "rivals": 1, "synergy": 1}}
"–Ø–Ω–¥–µ–∫—Å —Ñ–∏–Ω–∞–Ω—Å—ã" ‚Üí {{"name": "–Ø–Ω–¥–µ–∫—Å", "market": 1, "rivals": 1, "synergy": 1}}
"—Ä—ã–Ω–æ–∫ Tesla" ‚Üí {{"name": "Tesla", "market": 1, "rivals": 0, "synergy": 0}}
"""
        
        self.executive_summary_prompt = """
1. –†–û–õ–¨

‚Ä¢ –¢—ã ‚Äî –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª —Å 50-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º –≤ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–º —Ä–∞–∑–≤–∏—Ç–∏–∏ –∏ M&A, —Å –≥–ª—É–±–æ–∫–∏–º –æ–ø—ã—Ç–æ–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ —ç–∫–æ—Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –¥–ª—è Big Tech (Apple, Amazon, Yandex, Baidu, Tencent –∏ –ø—Ä.) –∏ –≥–ª—É–±–æ–∫–∏–º–∏ –∑–Ω–∞–Ω–∏—è–º–∏ —ç–∫–æ–Ω–æ–º–∏–∫–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ –Ω–æ–±–µ–ª–µ–≤—Å–∫–∏—Ö –ª–∞—É—Ä–µ–∞—Ç–æ–≤ –ø–æ —ç–∫–æ–Ω–æ–º–∏–∫–µ.
‚Ä¢ –í —Ç–≤–æ–∏ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ –≤—Ö–æ–¥–∏—Ç –ø–æ–∏—Å–∫ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π —Ä–∞–∑–≤–∏—Ç–∏—è —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã –°–±–µ—Ä–∞ —á–µ—Ä–µ–∑ M&A –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–∞. –¢—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –º–æ–∂–µ—à—å —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤/ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∞–∫—Ç–∏–≤—ã –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –∫–∞–∫ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —Ü–µ–ª–∏ –¥–ª—è –ø–æ–∫—É–ø–∫–∏, –ø—Ä–∏ —ç—Ç–æ–º –ø–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–∞ —Å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞–º–∏ –Ω–µ —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞—é—Ç—Å—è.
‚Ä¢ –¢—ã –¥–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—á–∞—Ç—å —Ç–æ–ª—å–∫–æ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø—Ä–æ —Ä–∞–∑–≤–∏—Ç–∏–µ —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã –°–±–µ—Ä–∞. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç—å —Å–¥–µ–ª–∞—Ç—å –¥–æ–ø—É—â–µ–Ω–∏–µ, –ø—Ä–æ–≤–æ–¥–∏ –∞–Ω–∞–ª–∏–∑ —Å —ç—Ç–∏–º –¥–æ–ø—É—â–µ–Ω–∏–µ–º.

2. –ö–û–ù–¢–ï–ö–°–¢

–°–±–µ—Ä –∏—â–µ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —É—Å–∏–ª–µ–Ω–∏—è –∏ —Ä–∞–∑–≤–∏—Ç–∏—è —Å–≤–æ–µ–π —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã –¥–ª—è b2b –∏ b2c –∫–ª–∏–µ–Ω—Ç–æ–≤, –ø–æ–≤—ã—à–µ–Ω–∏—è –ª–∏–ø–∫–æ—Å—Ç–∏ —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤, –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è network —ç—Ñ—Ñ–µ–∫—Ç–∞.

–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –°–±–µ—Ä–∞:
‚Ä¢ –†–∞–∑–≤–∏—Ç–∏–µ –∏ –∫–æ–º–º–µ—Ä—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞, –∞–Ω—Ç—Ä–æ–ø–æ–º–æ—Ä—Ñ–Ω–æ–π —Ä–æ–±–æ—Ç–æ—Ç–µ—Ö–Ω–∏–∫–∏, –±–µ—Å–ø–∏–ª–æ—Ç–Ω—ã—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π (–Ω–∞–∑–µ–º–Ω—ã–µ –∏ –≤–æ–∑–¥—É—à–Ω—ã–µ –±–µ—Å–ø–∏–ª–æ—Ç–Ω–∏–∫–∏), –º–∏–∫—Ä–æ—ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∏, –∫–≤–∞–Ω—Ç–æ–≤—ã—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π –∏ –ø—Ä–æ—á–∏—Ö –Ω–∞—É–∫–æ–µ–º–∫–∏—Ö –∏ –≤—ã—Å–æ–∫–æ—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–Ω—ã—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π, –≤ —Ç.—á. –≤—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π –≤ —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏ –±–∏–∑–Ω–µ—Å–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ –°–±–µ—Ä–∞.
‚Ä¢ –í–Ω–µ–¥—Ä–µ–Ω–∏–µ –ø–µ—Ä–µ–¥–æ–≤—ã—Ö –ò–ò-—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π –∏ –ò–ò-–∞–≥–µ–Ω—Ç–æ–≤ –≤ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –ø—É—Ç–∏ –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –±–∞–Ω–∫–∞ –∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –ò–ò-–ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∏ –ò–ò-–∞–≥–µ–Ω—Ç–æ–≤ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–µ–π –≤–Ω–µ—à–Ω–∏—Ö b2b –∏ b2c –∫–ª–∏–µ–Ω—Ç–æ–≤, —Ä–µ—à–µ–Ω–∏—è –∏—Ö —Å–ª–æ–∂–Ω—ã—Ö –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω—ã—Ö –∑–∞–¥–∞—á.
‚Ä¢ –†–∞–∑–≤–∏—Ç–∏–µ —Ç–µ–∫—É—â–∏—Ö –∏ –ø–æ–∏—Å–∫ –Ω–æ–≤—ã—Ö —á–∞—Å—Ç–æ—Ç–Ω—ã—Ö –∏ –≥–∏–ø–µ—Ä—á–∞—Å—Ç–æ—Ç–Ω—ã—Ö b2c —Å–µ—Ä–≤–∏—Å–æ–≤ (–≤ —Ç.—á. —Ç—É—Ä–∏–∑–º) –¥–ª—è —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã –°–±–µ—Ä–∞, –ø–æ–∏—Å–∫ –Ω–æ–≤—ã—Ö –ø–µ—Ä–µ–¥–æ–≤—ã—Ö –±–∏–∑–Ω–µ—Å-–º–æ–¥–µ–ª–µ–π.
‚Ä¢ –†–∞–∑–≤–∏—Ç–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –°–±–µ—Ä–ü—Ä–∞–π–º: –ø–æ–∏—Å–∫ –Ω–æ–≤—ã—Ö —á–∞—Å—Ç–æ—Ç–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤, —Ä–∞–∑–≤–∏—Ç–∏–µ –ª–∏–ø–∫–æ—Å—Ç–∏ –∏ —Å–µ—Ç–µ–≤–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏, –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–∏–≤—è–∑–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ –∫ —ç–∫–æ—Å–∏—Å—Ç–µ–º–µ –°–±–µ—Ä–∞.
‚Ä¢ –î–∞–ª—å–Ω–µ–π—à–µ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ —Ü–∏—Ñ—Ä–æ–≤—ã—Ö –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π –∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤: SberPay, –±–∏–æ–º–µ—Ç—Ä–∏—è, –°–±–µ—Ä–±–∞–Ω–∫ –û–Ω–ª–∞–π–Ω, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –ø—Ä–µ–º–∏–∞–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ (–°–±–µ—Ä–ë–∞–Ω–∫ –ü–µ—Ä–≤—ã–π, Private Banking), –∫—Ä–∏–ø—Ç–æ–±–∏—Ä–∂–∏ –∏ DeFi –ø—Ä–∏ —É—Å–ª–æ–≤–∏–∏ —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –†–§.
‚Ä¢ –†–∞–∑–≤–∏—Ç–∏–µ b2b —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã –°–±–µ—Ä–∞ —á–µ—Ä–µ–∑ –ø–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–∞ —Å –ª—É—á—à–∏–º–∏ —Ä—ã–Ω–æ—á–Ω—ã–º–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º–∏ —Å–µ—Ä–≤–∏—Å–æ–≤ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞ (–°–±–∏—Å, –ö–æ–Ω—Ç—É—Ä –∏ –ø—Ä.).

–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –°–±–µ—Ä—É:
‚Ä¢ –û—Ñ—Ñ–ª–∞–π–Ω-—Å–µ—Ä–≤–∏—Å—ã —Å —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã–º–∏ –±–∏–∑–Ω–µ—Å-–º–æ–¥–µ–ª—è–º–∏ (–°–¢–û, –ø–∞—Ä–∏–∫–º–∞—Ö–µ—Ä—Å–∫–∏–µ –∏ –ø—Ä.), —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã–µ –∏–Ω–¥—É—Å—Ç—Ä–∏–∏ (–ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å, –¥–æ–±—ã—á–∞, —ç–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞, —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ –∏ –ø—Ä.).
‚Ä¢ –í—ã—Å–æ–∫–æ—Ä–∏—Å–∫–æ–≤—ã–µ –±–∏–∑–Ω–µ—Å—ã (–±–µ—Ç—Ç–∏–Ω–≥, –ø–∏—Ä–∞—Ç—Å—Ç–≤–æ, –æ—Ñ—à–æ—Ä—ã, –º–∏–∫—Ä–æ—Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∏ –ø—Ä–æ—á–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ —Å –≤—ã—Å–æ–∫–∏–º —Å–∞–Ω–∫—Ü–∏–æ–Ω–Ω—ã–º –∏–ª–∏ —Ä–µ–ø—É—Ç–∞—Ü–∏–æ–Ω–Ω—ã–º —Ä–∏—Å–∫–æ–º).

–¢–µ–∫—É—â–∏–π —Å–æ—Å—Ç–∞–≤ —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã –°–±–µ—Ä–∞:
‚Ä¢ –ü–æ–¥–ø–∏—Å–∫–∞ –°–±–µ—Ä–ü—Ä–∞–π–º.
‚Ä¢ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —É—Å–ª—É–≥–∏: –°–±–µ—Ä –ö–ò–ë, –ÆMoney, –ÆKassa, –ü–ª–∞—Ç–∏ —á–∞—Å—Ç—è–º–∏ (BNPL-—Å–µ—Ä–≤–∏—Å), –°–±–µ—Ä–°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ, –≠–≤–æ—Ç–æ—Ä.
‚Ä¢ –≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –∫–æ–º–º–µ—Ä—Ü–∏—è: –ö—É–ø–µ—Ä, –ú–µ–≥–∞–ú–∞—Ä–∫–µ—Ç, –°–∞–º–æ–∫–∞—Ç, InSales.
‚Ä¢ –ú–µ–¥–∏–∞ –∏ —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è: Okko, –ó–≤—É–∫, –°–æ—é–∑–ú—É–ª—å—Ç–§–∏–ª—å–º, –†–∞–º–±–ª–µ—Ä.
‚Ä¢ –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ: –ê–ª–≥–æ—Ä–∏—Ç–º–∏–∫–∞, –§–æ–∫—Å—Ñ–æ—Ä–¥, –ù–µ—Ç–æ–ª–æ–≥–∏—è, –®–∫–æ–ª–∞ 21.
‚Ä¢ –ó–¥—Ä–∞–≤–æ–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: –°–±–µ—Ä–ó–¥–æ—Ä–æ–≤—å–µ.
‚Ä¢ –ú–æ–±–∏–ª—å–Ω–æ—Å—Ç—å: 2–ì–ò–°, –°–∏—Ç–∏–î—Ä–∞–π–≤.
‚Ä¢ –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è: –û—Ç–µ–ª–ª–æ
‚Ä¢ –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã: –ú–∞–Ω–∂–µ—Ä–æ–∫, –ê—ç—Ä–æ–ø–æ—Ä—Ç –ì–æ—Ä–Ω–æ-–ê–ª—Ç–∞–π—Å–∫, –ú—Ä–∏—è, –°–±–µ—Ä–°–∏—Ç–∏, —Å–µ—Ç—å –æ—Ç–¥–µ–ª–µ–Ω–∏–π –°–±–µ—Ä–∞.
‚Ä¢ –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥: SberAds, –°–±–µ—Ä–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥, –ò–Ω–¥–µ–∫—Å 20.
‚Ä¢ –ö–ª–∞—Å—Å–∏—Ñ–∞–π–¥—ã: –†–∞–±–æ—Ç–∞.—Ä—É, –°–±–µ—Ä–ê–≤—Ç–æ, –î–æ–º–ö–ª–∏–∫.
‚Ä¢ –¢–µ–ª–µ–∫–æ–º: –°–±–µ—Ä–ú–æ–±–∞–π–ª.
‚Ä¢ –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏: Cloud, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å –¥—Ä–æ–Ω–æ–≤, Navio, Fusionbrain.ai, Kandinsky, GigaChat, SberDevices.

–ü–æ–¥—Ö–æ–¥—ã –∫ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–º—É —Ä–∞–∑–≤–∏—Ç–∏—é:
‚Ä¢ –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –°–±–µ—Ä–∞ –∏ –∏—Ö –∞–∫—Ç–∏–≤—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞—é—Ç—Å—è –∫–∞–∫ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫ –ø–æ–∫—É–ø–∫–µ.
‚Ä¢ –ü–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–æ —Å –æ—Å–Ω–æ–≤–Ω—ã–º–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞–º–∏ –°–±–µ—Ä–∞ –Ω–µ —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç—Å—è.
‚Ä¢ –ü–æ–∫—É–ø–∫–∞/ –ø–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–æ —Å –∫–æ–º–ø–∞–Ω–∏—è–º–∏ —Å –º–∞–ª–æ–π —Ä—ã–Ω–æ—á–Ω–æ–π –¥–æ–ª–µ–π –Ω–µ —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç—Å—è.
‚Ä¢ –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–∫—É–ø–∫—É/ –ø–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–æ —Å –ª–∏–¥–µ—Ä–∞–º–∏ —Ä—ã–Ω–∫–∞. –°–±–µ—Ä –≥–æ—Ç–æ–≤ –º–æ–Ω–æ–ø–æ–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä—ã–Ω–∫–∏.
‚Ä¢ –ê–Ω—Ç–∏–º–æ–Ω–æ–ø–æ–ª—å–Ω—ã–µ —Ä–∏—Å–∫–∏, —Ä–∏—Å–∫–∏ –æ–±—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Ä–µ–∑–æ–Ω–∞–Ω—Å–∞ –∏ ESG-–ø—Ä–∏–Ω—Ü–∏–ø—ã –Ω–µ –ø—Ä–∏–Ω–∏–º–∞—é—Ç—Å—è –≤–æ –≤–Ω–∏–º–∞–Ω–∏–µ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –ø–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–∞, –Ω–µ –≤–ª–∏—è—é—Ç –Ω–∞ –∏—Ç–æ–≥–æ–≤—É—é —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é –ø–æ —Ñ–æ—Ä–º–∞—Ç—É –ø–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–∞.
‚Ä¢ –ï—Å–ª–∏ —Ä—ã–Ω–æ–∫ –∑—Ä–µ–ª—ã–π –∏ –º–æ–Ω–æ–ø–æ–ª–∏–∑–∏—Ä–æ–≤–∞–Ω (–¥–æ–ª—è —Ä—ã–Ω–∫–∞ –∫–æ–º–ø–∞–Ω–∏–∏-–ª–∏–¥–µ—Ä–∞ –ø—Ä–µ–≤—ã—à–∞–µ—Ç 60-70%), –∏–º–µ–µ—Ç —Å–º—ã—Å–ª —Ç–æ–ª—å–∫–æ –ø–æ–∫—É–ø–∫–∞ –∏–ª–∏ –ø–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–æ —Å –∫–æ–º–ø–∞–Ω–∏–µ–π-–º–æ–Ω–æ–ø–æ–ª–∏—Å—Ç–æ–º. –°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω—ã–π –≤—ã—Ö–æ–¥ –Ω–∞ —Ä—ã–Ω–æ–∫ –Ω–µ —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç—Å—è.
‚Ä¢ –í —Å–ª—É—á–∞–µ M&A –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ–π –æ–ø—Ü–∏–µ–π —è–≤–ª—è–µ—Ç—Å—è –ø–æ–∫—É–ø–∫–∞ 100% –∫–æ–º–ø–∞–Ω–∏–∏. –°–±–µ—Ä —Å—Ç–∞—Ä–∞–µ—Ç—Å—è –∏–∑–±–µ–≥–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–≤–º–µ—Å—Ç–Ω—ã—Ö –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π. 
‚Ä¢ –ß–∞—Å—Ç–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ –°–±–µ—Ä–æ–º —Å –Ω—É–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –±–∏–∑–Ω–µ—Å–∞ (greenfield) –æ–±—Ö–æ–¥–∏—Ç—Å—è –¥–æ—Ä–æ–∂–µ –µ–≥–æ –ø–æ–∫—É–ø–∫–∏.
‚Ä¢ –£ –°–±–µ—Ä–∞ —Å—Ç–∞—Ç—É—Å OFAC SDN (—Å–∞–Ω–∫—Ü–∏–æ–Ω–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è).

3. –ü–†–ò–ú–ï–† –°–¢–†–£–ö–¢–£–†–´ –†–ê–°–°–£–ñ–î–ï–ù–ò–ô

–≠—Ç–∞–ø 1. –†—ã–Ω–æ–∫ –∏–Ω—Ç–µ—Ä–µ—Å–µ–Ω –°–±–µ—Ä—É, –µ—Å–ª–∏ –æ–Ω:
‚Ä¢ –ü–æ–¥—Ö–æ–¥–∏—Ç –ø–æ–¥ —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –°–±–µ—Ä–∞ –∏–ª–∏ —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–µ —Ç–æ—á–∫–∏ —Ä–æ—Å—Ç–∞ –¥–ª—è —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã
‚Ä¢ C–æ–∑–¥–∞—ë—Ç –∑–Ω–∞—á–∏–º—ã–µ —Å–∏–Ω–µ—Ä–≥–∏–∏ –¥–ª—è —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã.
‚Ä¢ –ó–∞–∫–æ–Ω–µ–Ω –≤ –†–§ –∏ –Ω–µ –Ω–µ—Å–µ—Ç —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ä–µ–ø—É—Ç–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ä–∏—Å–∫–æ–≤.

–≠—Ç–∞–ø 2. –ö–æ–º–ø–∞–Ω–∏—è-—Ç–∞—Ä–≥–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å–Ω–∞ –°–±–µ—Ä—É, –µ—Å–ª–∏ –æ–Ω–∞:
‚Ä¢ –í—Ö–æ–¥–∏—Ç –≤ —Ç–æ–ø-3 –ª–∏–¥–µ—Ä–æ–≤ —Ä—ã–Ω–∫–∞, –∏–º–µ–µ—Ç –∑–Ω–∞—á–∏–º—É—é –¥–æ–ª—é —Ä—ã–Ω–∫–∞.
‚Ä¢ –ò–º–µ–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –∏ —ç–∫—Å–ø–µ—Ä—Ç–∏–∑—É.
‚Ä¢ –ù–µ—Ç –∑–Ω–∞—á–∏–º—ã—Ö —Ä–∏—Å–∫–æ–≤, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π –∫–æ–º–ø–∞–Ω–∏–∏ –≤ —ç–∫–æ—Å–∏—Å—Ç–µ–º—É –°–±–µ—Ä–∞.
–í —Å–ª—É—á–∞–µ, –µ—Å–ª–∏ –∫–æ–º–ø–∞–Ω–∏—è –Ω–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–∞, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –¥—Ä—É–≥–∏—Ö –ª–∏–¥–µ—Ä–æ–≤ —Ä—ã–Ω–∫–∞.

–≠—Ç–∞–ø 3. –°–∏–Ω–µ—Ä–≥–∏–∏ —è–≤–ª—è—é—Ç—Å—è –∑–Ω–∞—á–∏–º—ã–º–∏, –µ—Å–ª–∏:
‚Ä¢ –û–±—ä–µ–º —Å–∏–Ω–µ—Ä–≥–∏–π —è–≤–ª—è–µ—Ç—Å—è –∑–Ω–∞—á–∏–º—ã–º –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å–æ —Å—Ç–æ–∏–º–æ—Å—Ç—å—é M&A, –ø–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–∞ –∏–ª–∏ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏.
‚Ä¢ –ü–æ–Ω—è—Ç–Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –º–µ—Ö–∞–Ω–∏–∫–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∏–Ω–µ—Ä–≥–∏–π.
‚Ä¢ –°–∏–Ω–µ—Ä–≥–∏–∏ –æ—Ü–µ–Ω–∏–≤–∞—é—Ç—Å—è –∫–∞–∫ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã –°–±–µ—Ä–∞, —Ç–∞–∫ –∏ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –∫–æ–º–ø–∞–Ω–∏–∏-—Ç–∞—Ä–≥–µ—Ç–∞.

–≠—Ç–∞–ø 4. –í—ã–±–æ—Ä —Ñ–æ—Ä–º—ã —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞.
‚Ä¢ M&A –µ—Å–ª–∏:
- –ê–∫—Ç–∏–≤ –∫—Ä–∏—Ç–∏—á–µ–Ω –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –°–±–µ—Ä–∞.
- –ù—É–∂–µ–Ω –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –ø—Ä–æ–¥—É–∫—Ç–æ–º, –≤ —Ç–æ–º —á–∏—Å–ª–µ –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∏–Ω–µ—Ä–≥–∏–π, –≥–ª—É–±–æ–∫–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ –°–ë–û–õ –∏–ª–∏ –¥—Ä—É–≥–∏–µ —Å–µ—Ä–≤–∏—Å—ã —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã –°–±–µ—Ä–∞.
- –ù—É–∂–Ω–∞ –ø–µ—Ä–µ–¥–∞—á–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–≤ —Ç.—á. –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤).
- –ù—É–∂–µ–Ω –±—ã—Å—Ç—Ä—ã–π –≤—ã—Ö–æ–¥ –Ω–∞ —Ä—ã–Ω–æ–∫.
- –ù–∞ —Ä—ã–Ω–∫–µ –µ—Å—Ç—å –≤—ã—Å–æ–∫–∏–µ –±–∞—Ä—å–µ—Ä—ã –≤—Ö–æ–¥–∞, –≤ —Ç.—á. –µ—Å–ª–∏ —Ä—ã–Ω–æ–∫ –∑—Ä–µ–ª—ã–π –∏ –º–æ–Ω–æ–ø–æ–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, –±–æ–ª–µ–µ 60-70% —Ä—ã–Ω–∫–∞ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç—Å—è –∫–æ–º–ø–∞–Ω–∏–µ–π-—Ç–∞—Ä–≥–µ—Ç–æ–º.
- –ö–æ–º–ø–∞–Ω–∏—è-—Ç–∞—Ä–≥–µ—Ç –æ–±–ª–∞–¥–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω–æ–π —ç–∫—Å–ø–µ—Ä—Ç–∏–∑–æ–π –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è–º–∏.
‚Ä¢ Greenfield –µ—Å–ª–∏:
- –ê–∫—Ç–∏–≤ –∫—Ä–∏—Ç–∏—á–µ–Ω –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –°–±–µ—Ä–∞.
- –ù—É–∂–µ–Ω –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –ø—Ä–æ–¥—É–∫—Ç–æ–º, –≤ —Ç–æ–º —á–∏—Å–ª–µ –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∏–Ω–µ—Ä–≥–∏–π, –≥–ª—É–±–æ–∫–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ –°–ë–û–õ –∏–ª–∏ –¥—Ä—É–≥–∏–µ —Å–µ—Ä–≤–∏—Å—ã —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã –°–±–µ—Ä–∞.
- –ù—É–∂–Ω–∞ –ø–µ—Ä–µ–¥–∞—á–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–≤ —Ç.—á. –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤).
- –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏-—Ç–∞—Ä–≥–µ—Ç—ã –Ω–∞ —Ä—ã–Ω–∫–µ.
- –ï—Å—Ç—å —Å–∏–ª—å–Ω–∞—è —ç–∫—Å–ø–µ—Ä—Ç–∏–∑–∞ –≤–Ω—É—Ç—Ä–∏ –°–±–µ—Ä–∞.
‚Ä¢ –ü–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–æ –µ—Å–ª–∏:
- –ê–∫—Ç–∏–≤ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –ø–æ–¥ –∫–ª—é—á–µ–≤—ã–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞–∑–≤–∏—Ç–∏—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –°–±–µ—Ä–∞.
- –ü—Ä–∏ —ç—Ç–æ–º –µ—Å—Ç—å –∑–Ω–∞—á–∏–º—ã–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–Ω–µ—Ä–≥–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤ —Ä–∞–º–∫–∞—Ö –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–≥–æ –ø–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–∞ –±–µ–∑ –∫–æ–Ω—Ç—Ä–æ–ª—è –Ω–∞–¥ –ø—Ä–æ–¥—É–∫—Ç–æ–º.
- –ï—Å—Ç—å —Å–∞–Ω–∫—Ü–∏–æ–Ω–Ω—ã–µ —Ä–∏—Å–∫–∏ –≤ —Å–ª—É—á–∞–µ –ø–æ–∫—É–ø–∫–∏ –∫–æ–º–ø–∞–Ω–∏–∏ —Å —Ä—ã–Ω–∫–∞.

4. –ó–ê–î–ê–ß–ê –ò –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ü–µ–ª–µ—Å–æ–æ–±—Ä–∞–∑–Ω–æ—Å—Ç—å –ø–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–∞ –°–±–µ—Ä–∞ —Å –∫–æ–º–ø–∞–Ω–∏–µ–π [–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏]. 

–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ executive summary –¥–ª—è –≤—ã—Å—à–µ–≥–æ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞ –±–∞–Ω–∫–∞ ‚Äì –ø—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç –æ–±—ä–µ–º–æ–º –Ω–µ –±–æ–ª–µ–µ 250 —Å–ª–æ–≤ —Å —Ä–∞–∑–±–∏–≤–∫–æ–π –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞–±–∑–∞—Ü–µ–≤. –ö–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω—ã —á–∏—Å–ª–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏, —Ä—ã–Ω–æ—á–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π, –¥–µ–Ω–µ–∂–Ω–æ–π –æ—Ü–µ–Ω–∫–æ–π. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–∏–≤–æ–¥–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å–∏–Ω–µ—Ä–≥–∏–∏ —Å –¥–µ–Ω–µ–∂–Ω–æ–π –æ—Ü–µ–Ω–∫–æ–π –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç–æ–≤—ã–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–∞–≤–∞–π —Å—Å—ã–ª–∫–∏ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ (—Å 2020 –ø–æ 2025 –≥.).

–¶–µ–ª–µ–≤–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞: –∫–ª—é—á–µ–≤–æ–π –≤—ã–≤–æ–¥ –æ —Ü–µ–ª–µ—Å–æ–æ–±—Ä–∞–∑–Ω–æ—Å—Ç–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞ –∏ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –µ–≥–æ —Ñ–æ—Ä–º—ã (M&A, —Å–æ–≤–º–µ—Å—Ç–Ω–æ–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ, —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–æ–µ –ø–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–æ, –∏–ª–∏ —É—Ö–æ–¥ –≤ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω—É—é —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É), –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–π –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –∫–ª—é—á–µ–≤—ã–º–∏ —Ç–µ–∑–∏—Å–∞–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤ —Ç–æ–º —á–∏—Å–ª–µ –¥–æ–ª–∂–Ω—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ—Ö–≤–∞—Ç—ã–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã: (1) –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Ä—ã–Ω–∫–∞ –∏ —Ç—Ä–µ–Ω–¥–æ–≤ –Ω–∞ –Ω–µ–º, –æ–±—ä–µ–º —Ä—ã–Ω–∫–∞, –∫–ª—é—á–µ–≤—ã–µ –∏–≥—Ä–æ–∫–∏ (2) –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–∞–º–æ–π –∫–æ–º–ø–∞–Ω–∏–∏-—Ç–∞—Ä–≥–µ—Ç–∞, –Ω–∞–ª–∏—á–∏–µ –±–æ–ª–µ–µ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω—ã—Ö —Ç–∞—Ä–≥–µ—Ç–æ–≤ (3) –∫–ª—é—á–µ–≤—ã–µ —Å–∏–Ω–µ—Ä–≥–∏–∏ –º–µ–∂–¥—É –∫–æ–º–ø–∞–Ω–∏–µ–π –∏ —ç–∫–æ—Å–∏—Å—Ç–µ–º–æ–π –°–±–µ—Ä–∞, (4) –≤–æ–∑–º–æ–∂–Ω—ã–µ —Ä–∏—Å–∫–∏ (—Ä—ã–Ω–æ—á–Ω—ã–µ, –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å–Ω—ã–µ –∏ –ø—Ä–æ—á–∏–µ —Ä–∏—Å–∫–∏).

5. –ö–†–ò–¢–ï–†–ò–ò –ö–ê–ß–ï–°–¢–í–ê –û–¢–í–ï–¢–ê

–û—Ç–≤–µ—Ç –±—É–¥–µ—Ç –ø—Ä–∏–∑–Ω–∞–Ω –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–º, –µ—Å–ª–∏:
‚Ä¢ –û—Ç–≤–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∑–∞–¥–∞—á–µ –∏ —Ñ–æ—Ä–º–∞—Ç—É –æ—Ç–≤–µ—Ç–∞, —É—á—Ç–µ–Ω—ã –ø–æ–¥—Ö–æ–¥—ã –∫ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–º—É —Ä–∞–∑–≤–∏—Ç–∏—é.
‚Ä¢ –ü—Ä–∏–≤–µ–¥–µ–Ω—ã —Å—Å—ã–ª–∫–∏ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∏.
‚Ä¢ –ú–∏–Ω–∏–º—É–º –≤–æ–¥—ã –≤ —Ç–µ–∫—Å—Ç–µ, —Å—É—Ö–∏–µ –∫–æ—Ä–æ—Ç–∫–∏–µ —Ñ—Ä–∞–∑—ã.
‚Ä¢ –ü—Ä–æ–≥–Ω–æ–∑—ã —Ä—ã–Ω–∫–∞ –ø—Ä–∏–≤–µ–¥–µ–Ω—ã –Ω–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–µ –ø–æ—Å–ª–µ 2025 –≥–æ–¥–∞ –∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –≤ –¥–µ–Ω–µ–∂–Ω–æ–º –≤—ã—Ä–∞–∂–µ–Ω–∏–∏ (–º–ª–Ω —Ä—É–±.)
‚Ä¢ –ü—Ä–∏–≤–µ–¥–µ–Ω—ã –æ–±—ä–µ–º—ã –≤—ã—Ä—É—á–∫–∏ (–º–ª–Ω —Ä—É–±.) –ø–æ –∫–ª—é—á–µ–≤—ã–º —Ä—ã–Ω–æ—á–Ω—ã–º –∏–≥—Ä–æ–∫–∞–º.
‚Ä¢ –ü—Ä–∏–≤–µ–¥–µ–Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –º–µ—Ö–∞–Ω–∏–∫–∞ —Å–∏–Ω–µ—Ä–≥–∏–π –∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤—ã—Ö –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π, –æ–±—ä–µ–º —Å–∏–Ω–µ—Ä–≥–∏–π –æ—Ü–µ–Ω–µ–Ω –≤ –º–ª–Ω —Ä—É–±.
‚Ä¢ –°–∏–Ω–µ—Ä–≥–∏–∏ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω—ã –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã –°–±–µ—Ä–∞ –∏ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –∫–æ–º–ø–∞–Ω–∏–∏-—Ç–∞—Ä–≥–µ—Ç–∞. –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –Ω–∞–ª–∏—á–∏–µ —Å–∏–Ω–µ—Ä–≥–∏–π –º–µ–∂–¥—É –∫–æ–º–ø–∞–Ω–∏–µ–π-—Ç–∞—Ä–≥–µ—Ç–æ–º –∏ –≤—Å–µ–º–∏ –∫–æ–º–ø–∞–Ω–∏—è–º–∏ —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã –°–±–µ—Ä–∞.
‚Ä¢ –ê–Ω—Ç–∏–º–æ–Ω–æ–ø–æ–ª—å–Ω—ã–µ —Ä–∏—Å–∫–∏, —Ä–∏—Å–∫–∏ –æ–±—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Ä–µ–∑–æ–Ω–∞–Ω—Å–∞ –∏ ESG-–ø—Ä–∏–Ω—Ü–∏–ø—ã –Ω–µ –±—ã–ª–∏ –ø—Ä–∏–Ω—è—Ç—ã –≤–æ –≤–Ω–∏–º–∞–Ω–∏–µ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏, –Ω–µ –ø–æ–≤–ª–∏—è–ª–∏ –Ω–∞ –∏—Ç–æ–≥–æ–≤—É—é —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é –ø–æ —Ñ–æ—Ä–º–∞—Ç—É –ø–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–∞ –∏ –Ω–µ —É–∫–∞–∑–∞–Ω—ã –≤ —Å–∞–º–æ–º –æ—Ç–≤–µ—Ç–µ.
‚Ä¢ –ü—Ä–∏–≤–µ–¥–µ–Ω—ã –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ç–∞—Ä–≥–µ—Ç—ã, –µ—Å–ª–∏ –∏–∑–Ω–∞—á–∞–ª—å–Ω–∞—è –∫–æ–º–ø–∞–Ω–∏—è-—Ç–∞—Ä–≥–µ—Ç –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –°–±–µ—Ä—É.
–ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –≤ –æ—Ç–≤–µ—Ç–µ.
"""

    async def parse_user_request(self, user_text: str) -> Dict[str, Any]:
        """–ü–∞—Ä—Å–∏—Ç –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∞–Ω–∞–ª–∏–∑–∞."""
        try:
            model_api = ModelAPI(Models.chatgpt.value())
            messages = [
                {"role": "system", "content": "–¢—ã –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π –∫–æ–º–ø–∞–Ω–∏–π –∏–∑ —Ç–µ–∫—Å—Ç–∞. –û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–º JSON –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ —Ç–µ–∫—Å—Ç–∞."},
                {"role": "user", "content": self.analysis_prompt.format(user_text=user_text)}
            ]
            
            response = await model_api.get_response(messages)
            logger.info(f"Raw response from GPT: '{response}'")
            
            # –û—á–∏—â–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤
            cleaned_response = response.strip()
            
            # –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ JSON –≤ –æ—Ç–≤–µ—Ç–µ –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º
            json_patterns = [
                r'\{[^{}]*"name"[^{}]*"[^"]*"[^{}]*\}',  # JSON —Å name –≤ –∫–∞–≤—ã—á–∫–∞—Ö
                r'```json\s*(\{.*?\})\s*```',  # JSON –≤ –±–ª–æ–∫–µ –∫–æ–¥–∞
                r'```\s*(\{.*?\})\s*```',  # JSON –≤ –±–ª–æ–∫–µ –±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è —è–∑—ã–∫–∞
                r'\{.*?"name".*?\}',  # JSON —Å–æ–¥–µ—Ä–∂–∞—â–∏–π name
                r'\{.*\}',  # –õ—é–±–æ–π JSON
            ]
            
            result = None
            for i, pattern in enumerate(json_patterns):
                matches = re.findall(pattern, cleaned_response, re.DOTALL | re.IGNORECASE)
                for match in matches:
                    try:
                        json_text = match if isinstance(match, str) else match
                        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
                        json_text = json_text.strip().replace('\n', ' ').replace('\r', '')
                        logger.info(f"Trying to parse pattern {i}: '{json_text}'")
                        result = json.loads(json_text)
                        logger.info(f"Successfully parsed JSON: {result}")
                        break
                    except json.JSONDecodeError as e:
                        logger.warning(f"JSON decode error for pattern {i}: {e}, text: '{json_text}'")
                        continue
                if result:
                    break
            
            if result and "name" in result:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ –Ω–µ –ø—É—Å—Ç–æ–µ
                if result["name"] and result["name"].strip() != "":
                    # –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ –≤—Å–µ –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç
                    final_result = {
                        "name": result.get("name", "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è_–∫–æ–º–ø–∞–Ω–∏—è"),
                        "market": result.get("market", 1),
                        "rivals": result.get("rivals", 1), 
                        "synergy": result.get("synergy", 1)
                    }
                    logger.info(f"Final parsed result: {final_result}")
                    return final_result
            
            # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å, –ª–æ–≥–∏—Ä—É–µ–º –∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback
            logger.warning(f"Could not parse JSON from response: '{response}'. Using manual extraction.")
            
        except json.JSONDecodeError as e:
            logger.error(f"JSON decode error: {e}, response was: '{response}'")
        except Exception as e:
            logger.error(f"Unexpected error parsing user request: {e}")
        
        # Fallback: –ø—Ä–æ—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±–µ–∑ —Ä—É—á–Ω–æ–≥–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è
        fallback_result = {"name": "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è_–∫–æ–º–ø–∞–Ω–∏—è", "market": 1, "rivals": 1, "synergy": 1}
        logger.info(f"Using fallback result: {fallback_result}")
        return fallback_result
    

    async def run_analysis(self, analysis_params: Dict[str, Any], file_content: str = "") -> Dict[str, str]:
        results = {}
        system_prompts = SystemPrompts()
        model_api = ModelAPI(Models.chatgpt.value())
        
        company_name = analysis_params.get("name", "unknown_company")
        
        # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ —Ñ–∞–π–ª–∞
        additional_context = ""
        if file_content:
            additional_context = f"\n\n–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏–∑ —Ñ–∞–π–ª–∞:\n{file_content}"
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∞–ª–∏–∑—ã —Å–æ–≥–ª–∞—Å–Ω–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º
        if analysis_params.get("market", 0):
            try:
                # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–º–ø—Ç –∫–∞–∫ —Å—Ç—Ä–æ–∫—É
                market_prompt_raw = system_prompts.get_prompt(SystemPrompt.INVESTMENT_MARKET)
                
                # –ü–∞—Ä—Å–∏–º –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç
                parsed_prompt = self._parse_classical_prompt(market_prompt_raw)
                
                # –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏
                user_content = parsed_prompt["prompt"].replace("[–Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏]", company_name)
                full_user_content = user_content + additional_context
                
                messages = [
                    {"role": "system", "content": parsed_prompt["role"]},
                    {"role": "user", "content": full_user_content}
                ]
                
                results["market"] = await model_api.get_response(messages)
                logger.info("Market analysis completed")
            except Exception as e:
                logger.error(f"Error in market analysis: {e}")
                results["market"] = f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ —Ä—ã–Ω–∫–∞: {str(e)}"
        
        if analysis_params.get("rivals", 0):
            try:
                # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–º–ø—Ç –∫–∞–∫ —Å—Ç—Ä–æ–∫—É
                rivals_prompt_raw = system_prompts.get_prompt(SystemPrompt.INVESTMENT_RIVALS)
                
                # –ü–∞—Ä—Å–∏–º –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç
                parsed_prompt = self._parse_classical_prompt(rivals_prompt_raw)
                
                # –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏
                user_content = parsed_prompt["prompt"].replace("[–Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏]", company_name)
                full_user_content = user_content + additional_context
                
                messages = [
                    {"role": "system", "content": parsed_prompt["role"]},
                    {"role": "user", "content": full_user_content}
                ]
                
                results["rivals"] = await model_api.get_response(messages)
                logger.info("Rivals analysis completed")
            except Exception as e:
                logger.error(f"Error in rivals analysis: {e}")
                results["rivals"] = f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤: {str(e)}"
        
        if analysis_params.get("synergy", 0):
            try:
                # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å–∏–Ω–µ—Ä–≥–∏–∏
                synergy_prompt_raw = system_prompts.get_prompt(SystemPrompt.INVESTMENT_SYNERGY)
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç –ø—Ä–æ–º–ø—Ç–∞
                if isinstance(synergy_prompt_raw, dict):
                    system_content = synergy_prompt_raw.get("role", "")
                    user_content = synergy_prompt_raw.get("prompt", "")
                    user_content = user_content.replace("[–Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏]", company_name)
                    full_user_content = user_content + additional_context
                    
                    messages = [
                        {"role": "system", "content": system_content},
                        {"role": "user", "content": full_user_content}
                    ]
                elif isinstance(synergy_prompt_raw, str):
                    full_prompt = synergy_prompt_raw.replace("[–Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏]", company_name)
                    full_prompt = full_prompt + additional_context
                    
                    messages = [
                        {"role": "user", "content": full_prompt}
                    ]
                else:
                    raise ValueError(f"–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç –ø—Ä–æ–º–ø—Ç–∞: {type(synergy_prompt_raw)}")
                
                results["synergy"] = await model_api.get_response(messages)
                logger.info("Synergy analysis completed")
            except Exception as e:
                logger.error(f"Error in synergy analysis: {e}")
                results["synergy"] = f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ —Å–∏–Ω–µ—Ä–≥–∏–∏: {str(e)}"
        
        return results
    
    def _parse_classical_prompt(self, prompt_text: str) -> Dict[str, str]:
        """
        –ü–∞—Ä—Å–∏—Ç –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç —Ñ–æ—Ä–º–∞—Ç–∞ '–†–û–õ–¨. ... –ö–û–ù–¢–ï–ö–°–¢. ...' 
        –∏ —Ä–∞–∑–¥–µ–ª—è–µ—Ç –Ω–∞ —Ä–æ–ª—å –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç.
        """
        try:
            # –ò—â–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã –†–û–õ–¨ –∏ –ö–û–ù–¢–ï–ö–°–¢
            role_match = re.search(r'–†–û–õ–¨\.\s*(.*?)(?=\n\s*–ö–û–ù–¢–ï–ö–°–¢\.|\n\s*[–ê-–Ø–Å]+\.|\Z)', prompt_text, re.DOTALL | re.IGNORECASE)
            context_match = re.search(r'–ö–û–ù–¢–ï–ö–°–¢\.\s*(.*?)(?=\n\s*[–ê-–Ø–Å]+\.|\Z)', prompt_text, re.DOTALL | re.IGNORECASE)
            
            role = role_match.group(1).strip() if role_match else ""
            context = context_match.group(1).strip() if context_match else ""
            
            # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —á–∞—Å—Ç–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤–µ—Å—å —Ç–µ–∫—Å—Ç –∫–∞–∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç
            if not role and not context:
                context = prompt_text.strip()
                role = "–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫."
            
            return {
                "role": role,
                "prompt": context
            }
        except Exception as e:
            logger.warning(f"Error parsing classical prompt: {e}")
            return {
                "role": "–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫.",
                "prompt": prompt_text
            }

    def create_docx_report(self, company_name: str, analysis_results: Dict[str, str]) -> str:
        """–°–æ–∑–¥–∞–µ—Ç DOCX –æ—Ç—á–µ—Ç —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –∞–Ω–∞–ª–∏–∑–∞."""
        try:
            doc = Document()
            
            # –ó–∞–≥–æ–ª–æ–≤–æ–∫
            title = doc.add_heading(f'–ê–Ω–∞–ª–∏–∑ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω–æ–π –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏: {company_name}', 0)
            
            # –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–æ–≤
            if "market" in analysis_results:
                doc.add_heading('–†—ã–Ω–æ—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑', level=1)
                doc.add_paragraph(analysis_results["market"])
                doc.add_page_break()
            
            if "rivals" in analysis_results:
                doc.add_heading('–ê–Ω–∞–ª–∏–∑ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤', level=1)
                doc.add_paragraph(analysis_results["rivals"])
                doc.add_page_break()
            
            if "synergy" in analysis_results:
                doc.add_heading('–ê–Ω–∞–ª–∏–∑ —Å–∏–Ω–µ—Ä–≥–∏–∏', level=1)
                doc.add_paragraph(analysis_results["synergy"])
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
            temp_file = tempfile.NamedTemporaryFile(delete=False, suffix='.docx')
            doc.save(temp_file.name)
            temp_file.close()
            
            logger.info(f"DOCX report created: {temp_file.name}")
            return temp_file.name
            
        except Exception as e:
            logger.error(f"Error creating DOCX report: {e}")
            raise

    async def generate_executive_summary(self, docx_file_path: str) -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç executive summary –Ω–∞ –æ—Å–Ω–æ–≤–µ DOCX —Ñ–∞–π–ª–∞."""
        try:
            # –ß–∏—Ç–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ DOCX —Ñ–∞–π–ª–∞
            doc = Document(docx_file_path)
            doc_content = ""
            for paragraph in doc.paragraphs:
                doc_content += paragraph.text + "\n"
            
            model_api = ModelAPI(Models.chatgpt.value())
            messages = [
                {"role": "system", "content": self.executive_summary_prompt},
                {"role": "user", "content": f"–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∞–Ω–∞–ª–∏–∑–∞:\n\n{doc_content}"}
            ]
            
            executive_summary = await model_api.get_response(messages)
            logger.info("Executive summary generated")
            return executive_summary
            
        except Exception as e:
            logger.error(f"Error generating executive summary: {e}")
    async def create_final_report_with_qa(self, company_name: str, analysis_results: Dict[str, str], qa_history: list) -> str:
        """–°–æ–∑–¥–∞–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç —Å –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ Q&A."""
        try:
        # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç
            doc = Document()
        
        # –ó–∞–≥–æ–ª–æ–≤–æ–∫
            title = doc.add_heading(f'–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑: {company_name}', 0)
            title.alignment = 1  # –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ —Ü–µ–Ω—Ç—Ä—É
        
        # –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç—á–µ—Ç–∞
            from datetime import datetime
            date_paragraph = doc.add_paragraph(f'–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç—á–µ—Ç–∞: {datetime.now().strftime("%d.%m.%Y")}')
            date_paragraph.alignment = 1  # –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ —Ü–µ–Ω—Ç—Ä—É
        
            doc.add_page_break()
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–æ–≤ —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
            if "market" in analysis_results:
                doc.add_heading('1. –†—ã–Ω–æ—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑', level=1)
                self._add_formatted_content(doc, analysis_results["market"])
                doc.add_page_break()
        
            if "rivals" in analysis_results:
                doc.add_heading('2. –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤', level=1)
                self._add_formatted_content(doc, analysis_results["rivals"])
                doc.add_page_break()
        
            if "synergy" in analysis_results:
                doc.add_heading('3. –ê–Ω–∞–ª–∏–∑ —Å–∏–Ω–µ—Ä–≥–∏–∏', level=1)
                self._add_formatted_content(doc, analysis_results["synergy"])
            
                if qa_history:  # –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑—Ä—ã–≤ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å Q&A
                    doc.add_page_break()
        
        # –î–æ–±–∞–≤–ª—è–µ–º Q&A —Å–µ–∫—Ü–∏—é –µ—Å–ª–∏ –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã
            if qa_history:
                doc.add_heading('4. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –∏ –æ—Ç–≤–µ—Ç—ã', level=1)
            
                for i, qa in enumerate(qa_history, 1):
                # –î–æ–±–∞–≤–ª—è–µ–º –≤–æ–ø—Ä–æ—Å
                    question_para = doc.add_paragraph()
                    question_run = question_para.add_run(f"–í–æ–ø—Ä–æ—Å {i}: ")
                    question_run.bold = True
                    question_para.add_run(qa['question'])
                
                # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
                    answer_para = doc.add_paragraph()
                    answer_run = answer_para.add_run("–û—Ç–≤–µ—Ç: ")
                    answer_run.bold = True
                    self._add_formatted_content(doc, qa['answer'], is_sub_content=True)
                
                # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø –º–µ–∂–¥—É Q&A –ø–∞—Ä–∞–º–∏
                    if i < len(qa_history):
                        doc.add_paragraph()
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
            temp_file = tempfile.NamedTemporaryFile(delete=False, suffix='_final.docx')
            doc.save(temp_file.name)
            temp_file.close()
        
            logger.info(f"Final report with Q&A created: {temp_file.name}")
            return temp_file.name
        
        except Exception as e:
            logger.error(f"Error creating final report with Q&A: {e}")
        # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –±–∞–∑–æ–≤—ã–π –æ—Ç—á–µ—Ç
            return self.create_docx_report(company_name, analysis_results)

    def _add_formatted_content(self, doc, content: str, is_sub_content: bool = False):
        """–î–æ–±–∞–≤–ª—è–µ—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –≤ –¥–æ–∫—É–º–µ–Ω—Ç."""
        if not content:
            return
        
    # –†–∞–∑–±–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–∞ –ø–∞—Ä–∞–≥—Ä–∞—Ñ—ã
        paragraphs = content.split('\n\n')
    
        for para_text in paragraphs:
            if not para_text.strip():
                continue
            
            lines = para_text.strip().split('\n')
        
            for line in lines:
                line = line.strip()
                if not line:
                    continue
                
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å—Ç—Ä–æ–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º
                if line.startswith('##'):
                # –ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫ —É—Ä–æ–≤–Ω—è 2
                    heading_text = line.replace('##', '').strip()
                    if heading_text:
                        doc.add_heading(heading_text, level=2)
                elif line.startswith('#'):
                # –ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫ —É—Ä–æ–≤–Ω—è 1 
                    heading_text = line.replace('#', '').strip()
                    if heading_text:
                        doc.add_heading(heading_text, level=2 if is_sub_content else 1)
                elif line.startswith('**') and line.endswith('**'):
                # –ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø–∞—Ä–∞–≥—Ä–∞—Ñ
                    para = doc.add_paragraph()
                    run = para.add_run(line.replace('**', ''))
                    run.bold = True
                elif line.startswith('- ') or line.startswith('* '):
                # –ú–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫
                    bullet_text = line[2:].strip()
                    if bullet_text:
                        para = doc.add_paragraph(bullet_text, style='List Bullet')
                elif line[0].isdigit() and '. ' in line:
                # –ù—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫
                    numbered_text = line.split('. ', 1)[1] if '. ' in line else line
                    if numbered_text:
                        para = doc.add_paragraph(numbered_text, style='List Number')
                else:
                # –û–±—ã—á–Ω—ã–π –ø–∞—Ä–∞–≥—Ä–∞—Ñ
                    para = doc.add_paragraph()
                
                # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç –≤–Ω—É—Ç—Ä–∏ –ø–∞—Ä–∞–≥—Ä–∞—Ñ–∞
                    parts = line.split('**')
                    for i, part in enumerate(parts):
                        if part:
                            run = para.add_run(part)
                            if i % 2 == 1:  # –ù–µ—á–µ—Ç–Ω—ã–µ —á–∞—Å—Ç–∏ - –∂–∏—Ä–Ω—ã–µ
                                run.bold = True
        
        # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø –º–µ–∂–¥—É –ø–∞—Ä–∞–≥—Ä–∞—Ñ–∞–º–∏
            doc.add_paragraph()
    def _sanitize_filename(self, filename: str) -> str:
        """–û—á–∏—â–∞–µ—Ç –∏–º—è —Ñ–∞–π–ª–∞ –æ—Ç –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤."""
        if not filename or not filename.strip():
            return 'unknown_company'
    
    # –£–±–∏—Ä–∞–µ–º –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã –¥–ª—è –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
        sanitized = re.sub(r'[<>:"/\\|?*\x00-\x1f]', '_', str(filename))
    # –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –≤ –Ω–∞—á–∞–ª–µ –∏ –∫–æ–Ω—Ü–µ
        sanitized = sanitized.strip()
    # –ó–∞–º–µ–Ω—è–µ–º –ø—Ä–æ–±–µ–ª—ã –Ω–∞ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è
        sanitized = sanitized.replace(' ', '_')
    # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É
        if len(sanitized) > 50:
            sanitized = sanitized[:50]
    # –£–±–∏—Ä–∞–µ–º —Ç–æ—á–∫–∏ –≤ –∫–æ–Ω—Ü–µ (–ø—Ä–æ–±–ª–µ–º—ã –≤ Windows)
        sanitized = sanitized.rstrip('.')
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ –ø—É—Å—Ç–æ–π
        if not sanitized:
            return 'unknown_company'
        
        return sanitized

class BaseScenario(ABC):
    """–ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ —Å –æ–±—â–µ–π –ª–æ–≥–∏–∫–æ–π —Ä–∞–±–æ—Ç—ã —Å –∑–∞–ø—Ä–æ—Å–∞–º–∏, —Ñ–∞–π–ª–∞–º–∏ –∏ –æ—à–∏–±–∫–∞–º–∏."""

    def __init__(self, bot: Bot) -> None:
        self.bot = bot

    @abstractmethod
    async def process(self, *args, **kwargs) -> Any:  # –ò–∑–º–µ–Ω–∏–ª–∏ —Å–∏–≥–Ω–∞—Ç—É—Ä—É –Ω–∞ –±–æ–ª–µ–µ –≥–∏–±–∫—É—é
        pass

    @abstractmethod
    def register(self, dp: Dispatcher) -> None:
        pass

    async def process_investment_analysis(self, message, state, file_content=''):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω–æ–π –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏."""
        user_id = message.chat.id
        user_data = await state.get_data()
        user_query = user_data.get('user_query', '')

        await self.delete_message_by_id(user_id, user_data.get('processing_msg_id'))

        if not user_query and not file_content:
            await message.answer(
                '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–≤–µ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å –∏–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ —Å –∫–æ–º–∞–Ω–¥—ã /start',
            )
            return

        try:
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
            progress_msg = await message.answer('üîç –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –∑–∞–ø—Ä–æ—Å –∏ –æ–ø—Ä–µ–¥–µ–ª—è—é –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∞–Ω–∞–ª–∏–∑–∞...')
            
            # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –∞–Ω–∞–ª–∏–∑–∞
            processor = InvestmentAnalysisProcessor()
            
            # –ü–∞—Ä—Å–∏–º –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            analysis_params = await processor.parse_user_request(user_query)
            company_name = analysis_params.get("name", "unknown_company")
            
            await progress_msg.edit_text(f'üìä –ó–∞–ø—É—Å–∫–∞—é –∞–Ω–∞–ª–∏–∑ –¥–ª—è –∫–æ–º–ø–∞–Ω–∏–∏: {company_name}...')
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∞–ª–∏–∑
            analysis_results = await processor.run_analysis(analysis_params, file_content)
            
            await progress_msg.edit_text('üìÑ –°–æ–∑–¥–∞—é –æ—Ç—á–µ—Ç...')
            
            # –°–æ–∑–¥–∞–µ–º DOCX –æ—Ç—á–µ—Ç
            docx_file_path = processor.create_docx_report(company_name, analysis_results)
            
            await progress_msg.edit_text('üìù –ì–µ–Ω–µ—Ä–∏—Ä—É—é executive summary...')
            
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º executive summary
            executive_summary = await processor.generate_executive_summary(docx_file_path)
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
            await state.update_data(
                analysis_params=analysis_params,
                analysis_results=analysis_results,
                docx_file_path=docx_file_path,
                executive_summary=executive_summary,
                company_name=company_name,
                qa_history=[]  # –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –æ—Ç–≤–µ—Ç–æ–≤
            )
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º executive summary
            await self.send_markdown_response(message, executive_summary)
            
            await progress_msg.delete()
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
            keyboard = InvestmentActionsKeyboard()
            logger.info(f"Created keyboard: {keyboard}")
            actions_message = await message.answer(
                '–ß—Ç–æ –±—ã –≤—ã —Ö–æ—Ç–µ–ª–∏ —Å–¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ?', 
                reply_markup=keyboard
            )
            await UserStates.INVESTMENT_ACTIONS.set()
            logger.info(f"User {user_id} moved to INVESTMENT_ACTIONS state")
            logger.info(f"Actions message sent with ID: {actions_message.message_id}")
            
        except Exception as e:
            await self.handle_error(message, e, "investment_analysis")

    async def process_startups_scouting(self, message, state, file_content=''):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è —Å–∫–∞—É—Ç–∏–Ω–≥–∞ —Å—Ç–∞—Ä—Ç–∞–ø–æ–≤ (—Å—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞)."""
        user_id = message.chat.id
        user_data = await state.get_data()
        user_query = user_data.get('user_query', '')

        await self.delete_message_by_id(user_id, user_data.get('processing_msg_id'))

        if not user_query and not file_content:
            await message.answer(
                '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–≤–µ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å –∏–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ —Å –∫–æ–º–∞–Ω–¥—ã /start',
            )
            return

        if file_content:
            summary = await self.summarize_file_content(file_content)
            if not summary:
                await message.answer(
                    '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏ —Ñ–∞–π–ª–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.'
                )
                return
            file_context = f'\n\n–ö–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ —Ñ–∞–π–ª–∞ (—Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è):\n{summary}'
        else:
            file_context = ''

        chat_context = ChatContextManager()
        strategy = Models.chatgpt.value()
        model_api = ModelAPI(strategy)
        
        try:
            excel_search = ExcelSearchStrategy()
            excel_data = await excel_search.get_response([{'role': 'user', 'content': user_query}])
            full_query = f'{user_query}\n\n–†–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã —Å—Ç–∞—Ä—Ç–∞–ø–æ–≤:\n{excel_data}{file_context}'
            
            topic_name = user_data.get('chosen_topic')
            chat_context.add_message(user_id, topic_name, 'user', full_query)

            await self.bot.send_chat_action(chat_id=user_id, action='typing')
            messages = chat_context.get_limited_messages_for_api(user_id, topic_name, limit=0)
            response = await model_api.get_response(messages)

            system_prompts = SystemPrompts()
            detail_prompt_type = f'{topic_name.upper()}_DETAIL'
            detail_prompt = system_prompts.get_prompt(SystemPrompt[detail_prompt_type])
            detail_messages = [
                {'role': 'system', 'content': detail_prompt},
                {'role': 'user', 'content': full_query},
            ]
            detail_response = await model_api.get_response(detail_messages)
            chat_context.add_message(user_id, topic_name, 'assistant', response)
            
            await self.send_markdown_response(message, response)
            await self.send_html_detail_response(message, detail_response)

            await message.answer('–û—Å—Ç–∞–ª–∏—Å—å –ª–∏ —É –í–∞—Å –≤–æ–ø—Ä–æ—Å—ã?', reply_markup=ContinueKeyboard())
            await UserStates.ASKING_CONTINUE.set()
        except Exception as e:
            await self.handle_error(message, e, "startups_scouting")

    async def process_query_with_file(self, message, state, file_content='', skip_system_prompt=False, max_history=0):
        """–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —É—á–µ—Ç–æ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ç–µ–º—ã."""
        user_data = await state.get_data()
        topic_name = user_data.get('chosen_topic')
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–º—ã
        if topic_name == Topics.investment.name:
            await self.process_investment_analysis(message, state, file_content)
        elif topic_name == Topics.startups.name:
            await self.process_startups_scouting(message, state, file_content)
        else:
            # –î–ª—è –¥—Ä—É–≥–∏—Ö —Ç–µ–º –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—É—é –ª–æ–≥–∏–∫—É
            await self.process_legacy_query(message, state, file_content, skip_system_prompt, max_history)

    async def process_legacy_query(self, message, state, file_content='', skip_system_prompt=False, max_history=0):
        """–°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏."""
        user_id = message.chat.id
        user_data = await state.get_data()
        topic_name = user_data.get('chosen_topic')
        model_name = user_data.get('chosen_model', 'chatgpt')
        user_query = user_data.get('user_query', '')

        await self.delete_message_by_id(user_id, user_data.get('processing_msg_id'))

        if not user_query and not file_content:
            await message.answer(
                '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–≤–µ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å –∏–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ —Å –∫–æ–º–∞–Ω–¥—ã /start',
            )
            return

        if file_content:
            summary = await self.summarize_file_content(file_content)
            if not summary:
                await message.answer(
                    '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏ —Ñ–∞–π–ª–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.'
                )
                return
            file_context = f'\n\n–ö–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ —Ñ–∞–π–ª–∞ (—Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è):\n{summary}'
        else:
            file_context = ''

        chat_context = ChatContextManager()
        strategy = Models[model_name].value()
        model_api = ModelAPI(strategy)
        
        try:
            full_query = f'{user_query}{file_context}'
            chat_context.add_message(user_id, topic_name, 'user', full_query)

            await self.bot.send_chat_action(chat_id=user_id, action='typing')
            messages = chat_context.get_limited_messages_for_api(
                user_id,
                topic_name,
                limit=max_history,
                skip_system_prompt=skip_system_prompt,
            )
            response = await model_api.get_response(messages)

            system_prompts = SystemPrompts()
            detail_prompt_type = f'{topic_name.upper()}_DETAIL'
            detail_prompt = system_prompts.get_prompt(SystemPrompt[detail_prompt_type])
            
            if skip_system_prompt:
                user_assistant_history = [msg for msg in messages if msg['role'] != 'system'][-5:]
                detail_messages = [{'role': 'system', 'content': detail_prompt}] + user_assistant_history
            else:
                detail_messages = [
                    {'role': 'system', 'content': detail_prompt},
                    {'role': 'user', 'content': full_query},
                ]
            detail_response = await model_api.get_response(detail_messages)
            chat_context.add_message(user_id, topic_name, 'assistant', response)
            await self.send_markdown_response(message, response)
            await self.send_html_detail_response(message, detail_response)

            await message.answer('–û—Å—Ç–∞–ª–∏—Å—å –ª–∏ —É –í–∞—Å –≤–æ–ø—Ä–æ—Å—ã?', reply_markup=ContinueKeyboard())
            await UserStates.ASKING_CONTINUE.set()
        except Exception as e:
            await self.handle_error(message, e, model_name)

    async def send_markdown_response(self, message, response):
        escaped_response = self._escape_markdown(response)
        max_length = 4000
        for i in range(0, len(escaped_response), max_length):
            part = escaped_response[i : i + max_length]
            await message.answer(part, parse_mode='MarkdownV2')

    async def send_html_detail_response(self, message, detail_response):
        max_chunk_size = 3000
        detail_chunks = [
            detail_response[i : i + max_chunk_size] for i in range(0, len(detail_response), max_chunk_size)
        ]
        for i, chunk in enumerate(detail_chunks):
            chunk_without_links = self._remove_links(chunk)
            if i == 0:
                await message.answer(
                    f'<blockquote expandable>{html.escape(chunk_without_links)}</blockquote>',
                    parse_mode='HTML',
                )
            else:
                await message.answer(
                    f'<blockquote expandable>–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ ({i + 1}/{len(detail_chunks)}):\n\n{html.escape(chunk_without_links)}</blockquote>',
                    parse_mode='HTML',
                )

    async def delete_message_by_id(self, user_id, message_id):
        if message_id:
            try:
                await self.bot.delete_message(chat_id=user_id, message_id=message_id)
            except Exception:
                pass

    async def handle_error(self, message, e, model_name):
        logger.error(f'–û—à–∏–±–∫–∞ {model_name}: {e}', exc_info=True)

        token_limit = self._parse_token_limit_error(str(e))
        if token_limit:
            await message.answer(
                f'‚ö†Ô∏è –í—ã –ø—Ä–µ–≤—ã—Å–∏–ª–∏ –ª–∏–º–∏—Ç —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è –º–æ–¥–µ–ª–∏.\n–ú–∞–∫—Å–∏–º—É–º: {token_limit} —Ç–æ–∫–µ–Ω–æ–≤.\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–º–µ–Ω—å—à–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.'
            )
        else:
            await message.answer(
                '–ò–∑–≤–∏–Ω–∏—Ç–µ, –º–æ–π –º–∞–ª–µ–Ω—å–∫–∏–π –∫–æ–º–ø—å—é—Ç–µ—Ä –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω. –ü–æ—Å—Ç—É–ø–∞–µ—Ç —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ –∏–ª–∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.\n'
                '–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ –∏—Å—á–µ–∑–Ω–µ—Ç, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.'
            )

        await self.bot.send_message(
            chat_id=config.OWNER_ID,
            text=f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ {model_name} –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {message.chat.id}:\n{e}'
        )

    def _remove_links(self, text: str) -> str:
        try:
            return re.sub(r'\[([^\]]+)\]\([^)]+\)', r'\1', text)
        except Exception:
            return text

    def _escape_markdown(self, text: str) -> str:
        try:
            text = re.sub(r'\[([^\]]+)\]\([^)]+\)', r'\1', text)
            result = ''
            i = 0
            while i < len(text):
                if i + 1 < len(text) and text[i : i + 2] == '**':
                    end_pos = text.find('**', i + 2)
                    if end_pos != -1:
                        bold_content = text[i + 2 : end_pos]
                        escaped_content = ''
                        for char in bold_content:
                            if char in '_[]()~`>#+-=|{}.!':
                                escaped_content += f'\\{char}'
                            elif char == '*':
                                escaped_content += '\\*'
                            else:
                                escaped_content += char
                        result += f'*{escaped_content}*'
                        i = end_pos + 2
                        continue
                if text[i] in '_*[]()~`>#+-=|{}.!':
                    result += f'\\{text[i]}'
                else:
                    result += text[i]
                i += 1
            return result
        except Exception:
            return text

    def _parse_token_limit_error(self, error_text: str) -> int:
        match = re.search(r'Limit (\d+), Requested (\d+)', error_text)
        if match:
            return int(match.group(1))
        return None

    async def summarize_file_content(self, file_content: str) -> str:
        summary_prompt = SystemPrompts().get_prompt(SystemPrompt.FILE_SUMMARY)
        messages = [{'role': 'system', 'content': summary_prompt}, {'role': 'user', 'content': file_content}]
        model_api = ModelAPI(Models.chatgpt_file.value())
        try:
            summary = await model_api.get_response(messages)
            logger.info(f'–°—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è —Ñ–∞–π–ª–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –¥–ª–∏–Ω–∞ summary: {len(summary)} —Å–∏–º–≤–æ–ª–æ–≤')
            return summary
        except Exception as e:
            logger.error(f'–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏ —Ñ–∞–π–ª–∞: {e}', exc_info=True)
            return None


class InvestmentActionsHandler(BaseScenario):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–µ–π—Å—Ç–≤–∏–π –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è executive summary."""

    async def process(self, *args, **kwargs) -> None:  # –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Å–∏–≥–Ω–∞—Ç—É—Ä–∞
        # –ò–∑–≤–ª–µ–∫–∞–µ–º callback_query –∏ state –∏–∑ args –∏–ª–∏ kwargs
        if args:
            callback_query = args[0]
            state = args[1] if len(args) > 1 else kwargs.get('state')
        else:
            callback_query = kwargs.get('callback_query')
            state = kwargs.get('state')
            
        if not callback_query or not state:
            logger.error("InvestmentActionsHandler: missing callback_query or state parameter")
            return

        user_id = callback_query.from_user.id
        action = callback_query.data
        user_data = await state.get_data()
        
        logger.info(f"Investment actions handler: user {user_id}, action {action}")

        await callback_query.answer()

        if action == 'investment_regenerate':
            # –†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∞–Ω–∞–ª–∏–∑–∞
            await callback_query.message.delete()
            progress_msg = await callback_query.message.answer('üîÑ –ó–∞–ø—É—Å–∫–∞—é —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∞–Ω–∞–ª–∏–∑–∞...')
            
            try:
                # –ü–æ–≤—Ç–æ—Ä–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∞–ª–∏–∑
                processor = InvestmentAnalysisProcessor()
                analysis_params = user_data.get('analysis_params')
                company_name = user_data.get('company_name')
                
                analysis_results = await processor.run_analysis(analysis_params)
                docx_file_path = processor.create_docx_report(company_name, analysis_results)
                executive_summary = await processor.generate_executive_summary(docx_file_path)
                
                # –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                await state.update_data(
                    analysis_results=analysis_results,
                    docx_file_path=docx_file_path,
                    executive_summary=executive_summary,
                    qa_history=[]  # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é Q&A
                )
                
                await progress_msg.delete()
                await self.send_markdown_response(callback_query.message, executive_summary)
                await callback_query.message.answer(
                    '–ß—Ç–æ –±—ã –≤—ã —Ö–æ—Ç–µ–ª–∏ —Å–¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ?', 
                    reply_markup=InvestmentActionsKeyboard()
                )
                
            except Exception as e:
                await progress_msg.delete()
                await self.handle_error(callback_query.message, e, "regeneration")
            
        elif action == 'investment_ask_question':
            # –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Ä–µ–∂–∏–º—É –≤–æ–ø—Ä–æ—Å–æ–≤-–æ—Ç–≤–µ—Ç–æ–≤
            await callback_query.message.delete()
            await callback_query.message.answer(
                '‚ùì –ó–∞–¥–∞–π—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å –ø–æ –∞–Ω–∞–ª–∏–∑—É –∫–æ–º–ø–∞–Ω–∏–∏. –í—Å–µ –≤–æ–ø—Ä–æ—Å—ã –∏ –æ—Ç–≤–µ—Ç—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç.'
            )
            await UserStates.INVESTMENT_QA.set()
            
        elif action == 'investment_get_report':
            # –í—ã–±–æ—Ä —Å–ø–æ—Å–æ–±–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç—á–µ—Ç–∞
            await callback_query.message.edit_text(
                '–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç—á–µ—Ç–∞:',
                reply_markup=InvestmentReportKeyboard()
            )
            await UserStates.INVESTMENT_REPORT_OPTIONS.set()

    def register(self, dp: Dispatcher) -> None:
        logger.info("=== REGISTERING InvestmentActionsHandler ===")
        
        # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤—Å–µ—Ö –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
        dp.register_callback_query_handler(
            lambda c, state: self.process(c, state),  # –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º –≤ lambda
            lambda c: c.data in ['investment_regenerate', 'investment_ask_question', 'investment_get_report'],
            state=UserStates.INVESTMENT_ACTIONS,
        )
        
        logger.info("=== InvestmentActionsHandler REGISTERED SUCCESSFULLY ===")

class InvestmentQAHandler(BaseScenario):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–ø—Ä–æ—Å–æ–≤-–æ—Ç–≤–µ—Ç–æ–≤ –≤ —Ä–µ–∂–∏–º–µ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞."""

    async def process(self, *args, **kwargs) -> None:  # –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Å–∏–≥–Ω–∞—Ç—É—Ä–∞
        # –ò–∑–≤–ª–µ–∫–∞–µ–º message –∏ state –∏–∑ args –∏–ª–∏ kwargs
        if args:
            message = args[0]
            state = args[1] if len(args) > 1 else kwargs.get('state')
        else:
            message = kwargs.get('message')
            state = kwargs.get('state')
            
        if not message or not state:
            logger.error("InvestmentQAHandler: missing message or state parameter")
            return

        user_id = message.from_user.id
        user_data = await state.get_data()
        user_question = message.text
        
        company_name = user_data.get('company_name', '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è_–∫–æ–º–ø–∞–Ω–∏—è')
        qa_history = user_data.get('qa_history', [])

        try:
            # –ü—Ä–æ—Å—Ç–æ–π –ø—Ä–æ–º–ø—Ç —Ç–æ–ª—å–∫–æ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –∫–æ–º–ø–∞–Ω–∏–∏ –∏ —Ç–µ–∫—É—â–∏–º –≤–æ–ø—Ä–æ—Å–æ–º
            model_api = ModelAPI(Models.chatgpt.value())
            messages = [
                {"role": "system", "content": f"–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω–æ–º—É –∞–Ω–∞–ª–∏–∑—É. –û—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å –ø–æ –∫–æ–º–ø–∞–Ω–∏–∏ {company_name}. –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º."},
                {"role": "user", "content": user_question}
            ]
            
            await self.bot.send_chat_action(chat_id=user_id, action='typing')
            response = await model_api.get_response(messages)
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º Q&A –≤ –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –∏—Ç–æ–≥–æ–≤–æ–≥–æ –æ—Ç—á–µ—Ç–∞
            qa_history.append({
                "question": user_question,
                "answer": response
            })
            
            await state.update_data(qa_history=qa_history)
            
            await self.send_markdown_response(message, response)
            
            # –ö–Ω–æ–ø–∫–∞ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ –¥–µ–π—Å—Ç–≤–∏—è–º
            await message.answer(
                '–•–æ—Ç–∏—Ç–µ –∑–∞–¥–∞—Ç—å –µ—â–µ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤—ã–±–æ—Ä—É –¥–µ–π—Å—Ç–≤–∏–π?',
                reply_markup=types.InlineKeyboardMarkup().add(
                    types.InlineKeyboardButton('‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –¥–µ–π—Å—Ç–≤–∏—è–º', callback_data='back_to_investment_actions')
                )
            )
            
        except Exception as e:
            await self.handle_error(message, e, "investment_qa")

    def register(self, dp: Dispatcher) -> None:
        dp.register_message_handler(
            lambda message, state: self.process(message, state),  # –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º –≤ lambda
            content_types=['text'],
            state=UserStates.INVESTMENT_QA,
        )


class BackToInvestmentActionsHandler(BaseScenario):
    """–í–æ–∑–≤—Ä–∞—Ç –∫ –≤—ã–±–æ—Ä—É –¥–µ–π—Å—Ç–≤–∏–π –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞."""

    async def process(self, *args, **kwargs) -> None:  # –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Å–∏–≥–Ω–∞—Ç—É—Ä–∞
        # –ò–∑–≤–ª–µ–∫–∞–µ–º callback_query –∏ state –∏–∑ args –∏–ª–∏ kwargs
        if args:
            callback_query = args[0]
            state = args[1] if len(args) > 1 else kwargs.get('state')
        else:
            callback_query = kwargs.get('callback_query')
            state = kwargs.get('state')
            
        if not callback_query or not state:
            logger.error("BackToInvestmentActionsHandler: missing callback_query or state parameter")
            return

        logger.info(f"BackToInvestmentActionsHandler called by user {callback_query.from_user.id}")
        await callback_query.answer()
        await callback_query.message.edit_text(
            '–ß—Ç–æ –±—ã –≤—ã —Ö–æ—Ç–µ–ª–∏ —Å–¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ?',
            reply_markup=InvestmentActionsKeyboard()
        )
        await UserStates.INVESTMENT_ACTIONS.set()

    def register(self, dp: Dispatcher) -> None:
        logger.info("=== REGISTERING BackToInvestmentActionsHandler ===")
        dp.register_callback_query_handler(
            lambda c, state: self.process(c, state),  # –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º –≤ lambda
            lambda c: c.data == 'back_to_investment_actions',
            state='*',  # –†–∞–∑—Ä–µ—à–∞–µ–º –∏–∑ –ª—é–±–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        )
        logger.info("=== BackToInvestmentActionsHandler REGISTERED ===")



class InvestmentReportHandler(BaseScenario):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç—á–µ—Ç–∞."""

    def __init__(self, bot):
        super().__init__(bot)
        self.email_sender = EmailSender()

    async def process(self, *args, **kwargs) -> None:  # –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Å–∏–≥–Ω–∞—Ç—É—Ä–∞
        # –ò–∑–≤–ª–µ–∫–∞–µ–º callback_query –∏ state –∏–∑ args –∏–ª–∏ kwargs
        if args:
            callback_query = args[0]
            state = args[1] if len(args) > 1 else kwargs.get('state')
        else:
            callback_query = kwargs.get('callback_query')
            state = kwargs.get('state')
            
        if not callback_query or not state:
            logger.error("InvestmentReportHandler: missing callback_query or state parameter")
            return

        user_id = callback_query.from_user.id
        action = callback_query.data
        user_data = await state.get_data()

        logger.info(f"InvestmentReportHandler: user {user_id}, action {action}")
        await callback_query.answer()

        if action == 'investment_download':
            await self._download_report(callback_query, state, user_data)
        elif action == 'investment_email':
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –ª–∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ email
            if not self.email_sender.email_user or not self.email_sender.email_password:
                await callback_query.message.edit_text(
                    '‚ùå –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ email –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –í–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ–º –æ—Ç—á–µ—Ç–∞.',
                    reply_markup=InvestmentReportKeyboard()
                )
                return
                
            await callback_query.message.edit_text('üìß –í–≤–µ–¥–∏—Ç–µ –≤–∞—à email –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç—á–µ—Ç–∞:')
            await UserStates.ENTERING_EMAIL.set()
        elif action == 'investment_back_to_actions':
            await callback_query.message.edit_text(
                '–ß—Ç–æ –±—ã –≤—ã —Ö–æ—Ç–µ–ª–∏ —Å–¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ?',
                reply_markup=InvestmentActionsKeyboard()
            )
            await UserStates.INVESTMENT_ACTIONS.set()

    async def _download_report(self, callback_query, state, user_data):
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç—á–µ—Ç –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è."""
        try:
            await callback_query.message.edit_text('üìÑ –ì–µ–Ω–µ—Ä–∏—Ä—É—é —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç...')
            
            processor = InvestmentAnalysisProcessor()
            company_name = user_data.get('company_name', 'unknown_company')
            analysis_results = user_data.get('analysis_results')
            qa_history = user_data.get('qa_history', [])
            
            # –°–æ–∑–¥–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –æ—Ç—á–µ—Ç —Å Q&A
            final_report_path = await processor.create_final_report_with_qa(
                company_name, analysis_results, qa_history
            )
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞
            safe_company_name = processor._sanitize_filename(company_name)
            if not safe_company_name:
                safe_company_name = "unknown_company"
            report_filename = f'investment_analysis_{safe_company_name}_final.docx'
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª
            with open(final_report_path, 'rb') as doc_file:
                await callback_query.message.answer_document(
                    document=types.InputFile(doc_file, filename=report_filename),
                    caption=f'üìã –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –ø–æ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω–æ–º—É –∞–Ω–∞–ª–∏–∑—É: {company_name}'
                )
            
            # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
            os.unlink(final_report_path)
            
            await callback_query.message.answer(
                '–û—Ç—á–µ—Ç –≥–æ—Ç–æ–≤! –ß—Ç–æ –±—ã –≤—ã —Ö–æ—Ç–µ–ª–∏ —Å–¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ?',
                reply_markup=InvestmentActionsKeyboard()
            )
            await UserStates.INVESTMENT_ACTIONS.set()
            
        except Exception as e:
            await self.handle_error(callback_query.message, e, "report_generation")

    def register(self, dp: Dispatcher) -> None:
        logger.info("=== REGISTERING InvestmentReportHandler ===")
        dp.register_callback_query_handler(
            lambda c, state: self.process(c, state),  # –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º –≤ lambda
            lambda c: c.data in ['investment_download', 'investment_email', 'investment_back_to_actions'],
            state=UserStates.INVESTMENT_REPORT_OPTIONS,
        )
        logger.info("=== InvestmentReportHandler REGISTERED ===")


class EmailInputHandler(BaseScenario):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ email –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç—á–µ—Ç–∞."""

    def __init__(self, bot):
        super().__init__(bot)
        self.email_sender = EmailSender()

    async def process(self, *args, **kwargs) -> None:  # –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Å–∏–≥–Ω–∞—Ç—É—Ä–∞
        # –ò–∑–≤–ª–µ–∫–∞–µ–º message –∏ state –∏–∑ args –∏–ª–∏ kwargs
        if args:
            message = args[0]
            state = args[1] if len(args) > 1 else kwargs.get('state')
        else:
            message = kwargs.get('message')
            state = kwargs.get('state')
            
        if not message or not state:
            logger.error("EmailInputHandler: missing message or state parameter")
            return
            
        email = message.text.strip()
        user_data = await state.get_data()
        
        # –ü—Ä–æ—Å—Ç–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è email
        if '@' not in email or '.' not in email:
            await message.answer('‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email. –í–≤–µ–¥–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π email:')
            return
        
        try:
            await message.answer('üìß –ì–µ–Ω–µ—Ä–∏—Ä—É—é –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é –æ—Ç—á–µ—Ç –Ω–∞ –ø–æ—á—Ç—É...')
            
            processor = InvestmentAnalysisProcessor()
            company_name = user_data.get('company_name', 'unknown_company')
            analysis_results = user_data.get('analysis_results')
            qa_history = user_data.get('qa_history', [])
            
            # –°–æ–∑–¥–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç
            final_report_path = await processor.create_final_report_with_qa(
                company_name, analysis_results, qa_history
            )
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞
            safe_company_name = processor._sanitize_filename(company_name)
            if not safe_company_name:
                safe_company_name = "unknown_company"
            report_filename = f'investment_analysis_{safe_company_name}_final.docx'
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ email —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º –∏–º–µ–Ω–µ–º —Ñ–∞–π–ª–∞
            success = await self.email_sender.send_report(
                email, 
                company_name, 
                final_report_path,
                filename=report_filename
            )
            
            # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
            if os.path.exists(final_report_path):
                os.unlink(final_report_path)
            
            if success:
                await message.answer(f'‚úÖ –û—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ {email}')
            else:
                await message.answer(f'‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç –Ω–∞ {email}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–∫–∞—á–∞—Ç—å –æ—Ç—á–µ—Ç.')
            
            await message.answer(
                '–ß—Ç–æ –±—ã –≤—ã —Ö–æ—Ç–µ–ª–∏ —Å–¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ?',
                reply_markup=InvestmentActionsKeyboard()
            )
            await UserStates.INVESTMENT_ACTIONS.set()
            
        except Exception as e:
            await self.handle_error(message, e, "email_sending")

    def register(self, dp: Dispatcher) -> None:
        logger.info("=== REGISTERING EmailInputHandler ===")
        dp.register_message_handler(
            lambda message, state: self.process(message, state),  # –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º –≤ lambda
            content_types=['text'],
            state=UserStates.ENTERING_EMAIL,
        )
        logger.info("=== EmailInputHandler REGISTERED ===")


class Access(BaseScenario):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –∫ –±–æ—Ç—É."""

    async def process(self, message: types.Message, state: FSMContext, **kwargs) -> NotImplemented:
        raise NotImplementedError()

    async def authorize_process(self, callback_query: types.CallbackQuery, state: FSMContext, **kwargs) -> None:
        admin_id = callback

class Access(BaseScenario):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –∫ –±–æ—Ç—É."""

    async def process(self, message: types.Message, state: FSMContext, **kwargs) -> NotImplemented:
        raise NotImplementedError()

    async def authorize_process(self, callback_query: types.CallbackQuery, state: FSMContext, **kwargs) -> None:
        admin_id = callback

class Access(BaseScenario):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –∫ –±–æ—Ç—É."""

    async def process(self, message: types.Message, state: FSMContext, **kwargs) -> NotImplemented:
        raise NotImplementedError()

    async def authorize_process(self, callback_query: types.CallbackQuery, state: FSMContext, **kwargs) -> None:
        admin_id = callback_query.from_user.id
        logger.info(f'–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {admin_id} –∞–≤—Ç–æ—Ä–∏–∑—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è')

        callback_message = callback_query.message.text
        try:
            authorized_user_id = int(callback_message.split('id: ')[1].split(')')[0])

            if config._users is None:
                _ = config.USERS

            config._users.append(authorized_user_id)

            msg = '–î–æ—Å—Ç—É–ø –ø–æ–ª—É—á–µ–Ω. –û—Ç–ø—Ä–∞–≤—å—Ç–µ /start –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã —Å –±–æ—Ç–æ–º.'
            await self.bot.send_message(chat_id=authorized_user_id, text=msg)

            admin_msg = f'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {authorized_user_id} —É—Å–ø–µ—à–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω.'
            await callback_query.message.edit_text(admin_msg)

            logger.info(f'–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {authorized_user_id} –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ')
        except Exception as e:
            error_msg = f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {str(e)}'
            logger.error(error_msg, exc_info=True)
            await callback_query.message.reply(error_msg)

    async def decline_process(self, callback_query: types.CallbackQuery, state: FSMContext, **kwargs) -> None:
        admin_id = callback_query.from_user.id
        logger.info(f'–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {admin_id} –æ—Ç–∫–ª–æ–Ω—è–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è')

        callback_message = callback_query.message.text
        try:
            declined_user_id = int(callback_message.split('id: ')[1].split(')')[0])
            logger.info(f'–ò–∑–≤–ª–µ—á–µ–Ω ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è: {declined_user_id}')

            config._blocked_users.add(declined_user_id)
            logger.info(f'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {declined_user_id} –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–ø–∏—Å–æ–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö')

            msg = '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.'
            await self.bot.send_message(chat_id=declined_user_id, text=msg)

            admin_msg = f'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {declined_user_id} –æ—Ç–∫–ª–æ–Ω–µ–Ω –∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.'
            await callback_query.message.edit_text(admin_msg)

            logger.info(f'–û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {declined_user_id} –∑–∞–≤–µ—Ä—à–µ–Ω–æ')
        except Exception as e:
            error_msg = f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {str(e)}'
            logger.error(error_msg, exc_info=True)
            await callback_query.message.reply(error_msg)
            self.bot.send_message(chat_id=config.OWNER_ID, text=error_msg)

    def register(self, dp: Dispatcher) -> None:
        dp.register_callback_query_handler(
            self.authorize_process,
            lambda c: c.data == 'authorize_yes',
            state='*',
        )
        dp.register_callback_query_handler(
            self.decline_process,
            lambda c: c.data == 'authorize_no',
            state='*',
        )


class StartHandler(BaseScenario):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ /start –∫–æ–º–∞–Ω–¥—ã."""

    async def process(self, message: types.Message, **kwargs) -> None:
        user_id = message.from_user.id
        user_name = f'{message.from_user.first_name} {message.from_user.last_name}'
        logger.info(f'–ö–æ–º–∞–Ω–¥–∞ /start –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} ({user_name})')

        chat_context = ChatContextManager()
        logger.info(f'–ó–∞–≤–µ—Ä—à–∞–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —á–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} –ø—Ä–∏ /start')
        chat_context.end_active_chats(user_id)
        logger.info(f'–û—á–∏—â–∞–µ–º –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ —á–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} –ø—Ä–∏ /start')
        chat_context.cleanup_user_context(user_id)

        if user_id not in config.AUTHORIZED_USERS_IDS:
            logger.info(f'–ó–∞–ø—Ä–æ—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è {user_id} –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º {config.ADMIN_USERS}')
            await message.answer('–ó–∞–ø—Ä–∞—à–∏–≤–∞—é –¥–æ—Å—Ç—É–ø —É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.')
            user_first_name = message.from_user.first_name
            user_last_name = message.from_user.last_name
            msg = f'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_first_name} {user_last_name} (id: {user_id}) –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø.'
            for admin_user in config.ADMIN_USERS:
                await self.bot.send_message(
                    chat_id=admin_user,
                    text=msg,
                    reply_markup=AuthorizeKeyboard(),
                )
            await UserStates.ACCESS.set()
        else:
            await message.answer('–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ß–µ–º —è –º–æ–≥—É –≤–∞–º –ø–æ–º–æ—á—å?', reply_markup=TopicKeyboard())
            await UserStates.CHOOSING_TOPIC.set()

    def register(self, dp: Dispatcher) -> None:
        dp.register_message_handler(self.process, commands=['start'], state='*')


class ProcessingChooseTopicCallback(BaseScenario):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç–µ–º—ã."""

    async def process(self, callback_query: types.CallbackQuery, state: FSMContext, **kwargs) -> None:
        user_id = callback_query.from_user.id
        topic_callback = callback_query.data
        topic_name = topic_callback.replace('topic_', '')

        await callback_query.answer()

        logger.info(f'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –≤—ã–±—Ä–∞–ª —Ç–µ–º—É: {topic_name}')

        system_prompts = SystemPrompts()
        system_prompt = system_prompts.get_prompt(SystemPrompt[topic_name.upper()])

        chat_context = ChatContextManager()
        chat_context.start_new_chat(user_id, topic_name, system_prompt)

        await state.update_data(chosen_topic=topic_name)
        await state.update_data(chosen_model='chatgpt')

        await callback_query.message.delete()

        examples = {
            'investment': '–ü–æ–∫—É–ø–∫–∞/–ü–∞—Ä—Ç–Ω—ë—Ä—Å—Ç–≤–æ —Å \*–∏–º—è –∫–æ–º–ø–∞–Ω–∏–∏\*',
            'startups': '–ü–æ–∏—Å–∫ —Å—Ç–∞—Ä—Ç–∞–ø–æ–≤ –≤ —Å—Ñ–µ—Ä–µ \*–Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ñ–µ—Ä—ã\*',
        }
        example = examples[topic_name]
        prompt_example = f'–ö–∞–∫–æ–π –í–∞—à –∑–∞–ø—Ä–æ—Å?\n_–ü—Ä–∏–º–µ—Ä: {example}_'
        prompt_message = await callback_query.message.answer(prompt_example, parse_mode='MarkdownV2')

        await state.update_data(prompt_message_id=prompt_message.message_id)
        await UserStates.ENTERING_PROMPT.set()

    def register(self, dp: Dispatcher) -> None:
        dp.register_callback_query_handler(
            self.process,
            lambda c: c.data.startswith('topic_'),
            state=UserStates.CHOOSING_TOPIC,
        )


class ProcessingEnterPromptHandler(BaseScenario):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º."""

    async def process(self, message: types.Message, state: FSMContext, **kwargs) -> None:
        user_id = message.from_user.id
        user_data = await state.get_data()
        topic_name = user_data['chosen_topic']
        model_name = user_data['chosen_model']

        logger.info(f'–ü–æ–ª—É—á–µ–Ω —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –æ—Ç {user_id}: –º–æ–¥–µ–ª—å={model_name}, —Ç–µ–º–∞={topic_name}')

        if 'prompt_message_id' in user_data:
            try:
                await self.bot.delete_message(chat_id=user_id, message_id=user_data['prompt_message_id'])
            except Exception as e:
                logger.error(f'–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è {user_data["prompt_message_id"]}: {e}')

        await state.update_data(user_query=message.text)

        file_message = await message.answer(
            '–•–æ—Ç–∏—Ç–µ –ª–∏ –≤—ã –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª (PDF, Word, PPT) –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞?',
            reply_markup=FileAttachKeyboard(),
        )

        await state.update_data(file_message_id=file_message.message_id)
        await UserStates.ATTACHING_FILE.set()

    def register(self, dp: Dispatcher) -> None:
        dp.register_message_handler(
            self.process,
            content_types=['text'],
            state=UserStates.ENTERING_PROMPT,
        )


class AttachFileHandler(BaseScenario):
    """–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞ (–ø–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å –∏ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞)."""

    async def process(self, callback_query: types.CallbackQuery, state: FSMContext, **kwargs) -> None:
        user_id = callback_query.from_user.id
        user_data = await state.get_data()
        await callback_query.answer()
        await self.delete_message_by_id(user_id, user_data.get('file_message_id'))
        if callback_query.data == 'attach_file':
            file_prompt = await callback_query.message.answer('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª (PDF, Word, PPT):')
            await state.update_data(file_prompt_id=file_prompt.message_id)
            await UserStates.UPLOADING_FILE.set()
        else:
            # –ë–µ–∑ —Ñ–∞–π–ª–∞, —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
            skip_system_prompt = user_data.get('skip_system_prompt', False)
            max_history = 10 if skip_system_prompt else 0
            await self.process_query_with_file(
                callback_query.message,
                state,
                file_content='',
                skip_system_prompt=skip_system_prompt,
                max_history=max_history,
            )

    def register(self, dp: Dispatcher) -> None:
        dp.register_callback_query_handler(
            self.process,
            lambda c: c.data in ['attach_file', 'no_file'],
            state=[UserStates.ATTACHING_FILE, UserStates.ATTACHING_FILE_CONTINUE],
        )


class UploadFileHandler(BaseScenario):
    """–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ (–ø–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å –∏ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞)."""

    async def process(self, message: types.Message, state: FSMContext, **kwargs) -> None:
        user_id = message.from_user.id
        user_data = await state.get_data()
        await self.delete_message_by_id(user_id, user_data.get('file_prompt_id'))
        if not message.document:
            await message.answer('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –≤ —Ñ–æ—Ä–º–∞—Ç–µ PDF, Word –∏–ª–∏ PowerPoint.')
            return
        file_name = message.document.file_name
        file_size = message.document.file_size
        logger.info(f'–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞: {file_name} ({file_size} –±–∞–π—Ç)')
        try:
            processing_msg = await message.answer('–ò–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞...')
            file_content = await FileProcessor.extract_text_from_file(message.document, self.bot)
            logger.info(f'–ò–∑–≤–ª–µ—á–µ–Ω–æ {len(file_content)} —Å–∏–º–≤–æ–ª–æ–≤ –∏–∑ —Ñ–∞–π–ª–∞ {file_name}')
            await state.update_data(processing_msg_id=processing_msg.message_id)
            skip_system_prompt = user_data.get('skip_system_prompt', False)
            max_history = 10 if skip_system_prompt else 0
            await self.process_query_with_file(
                message,
                state,
                file_content,
                skip_system_prompt=skip_system_prompt,
                max_history=max_history,
            )
        except ValueError as e:
            logger.error(f'–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞ {file_name}: {e}')
            await message.answer(
                '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞. –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–∞–∂–∞–≤ –∫–æ–º–∞–Ω–¥—É /start',
            )
            await self.bot.send_message(
                chat_id=config.OWNER_ID,
                text=f'{e}',
            )

    def register(self, dp: Dispatcher) -> None:
        dp.register_message_handler(
            self.process,
            content_types=['document'],
            state=[UserStates.UPLOADING_FILE, UserStates.UPLOADING_FILE_CONTINUE],
        )


class ProcessingContinueCallback(BaseScenario):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞."""

    async def process(self, callback_query: types.CallbackQuery, state: FSMContext, **kwargs) -> None:
        user_id = callback_query.from_user.id
        continue_callback = callback_query.data
        user_data = await state.get_data()

        await callback_query.answer()

        if continue_callback == 'continue_yes':
            logger.info(f'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} —Ä–µ—à–∏–ª –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –¥–∏–∞–ª–æ–≥')
            await callback_query.message.delete()

            await state.update_data(skip_system_prompt=True)

            prompt_message = await self.bot.send_message(chat_id=user_id, text='–í–≤–µ–¥–∏—Ç–µ –≤–∞—à —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å:')
            await state.update_data(prompt_message_id=prompt_message.message_id)
            await UserStates.CONTINUE_DIALOG.set()
        else:
            logger.info(f'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} —Ä–µ—à–∏–ª –Ω–∞—á–∞—Ç—å –Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥')
            await state.finish()
            await callback_query.message.delete()
            await self.bot.send_message(
                chat_id=user_id,
                text='–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:',
                reply_markup=TopicKeyboard(),
            )
            await UserStates.CHOOSING_TOPIC.set()

    def register(self, dp: Dispatcher) -> None:
        dp.register_callback_query_handler(
            self.process,
            lambda c: c.data in ['continue_yes', 'continue_no'],
            state=UserStates.ASKING_CONTINUE,
        )


class ContinueDialogHandler(BaseScenario):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞ —Å —Ç–æ–π –∂–µ –º–æ–¥–µ–ª—å—é –∏ —Ç–µ–º–æ–π."""

    async def process(self, message: types.Message, state: FSMContext, **kwargs) -> None:
        user_id = message.from_user.id
        user_data = await state.get_data()
        topic_name = user_data['chosen_topic']
        model_name = user_data['chosen_model']

        logger.info(
            f'–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞: {user_id}, –º–æ–¥–µ–ª—å={model_name}, —Ç–µ–º–∞={topic_name}, —Ç–∏–ø={message.content_type}',
        )

        if 'prompt_message_id' in user_data:
            try:
                await self.bot.delete_message(chat_id=user_id, message_id=user_data['prompt_message_id'])
            except Exception as e:
                logger.error(f'–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è {user_data["prompt_message_id"]}: {e}')

        await state.update_data(user_query=message.text)

        file_message = await message.answer(
            '–•–æ—Ç–∏—Ç–µ –ª–∏ –≤—ã –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª (PDF, Word, PPT) –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞?',
            reply_markup=FileAttachKeyboard(),
        )

        await state.update_data(file_message_id=file_message.message_id)
        await UserStates.ATTACHING_FILE_CONTINUE.set()

    def register(self, dp: Dispatcher) -> None:
        dp.register_message_handler(self.process, content_types=['text'], state=UserStates.CONTINUE_DIALOG)


class ResetStateHandler(BaseScenario):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /reset –¥–ª—è —Å–±—Ä–æ—Å–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""

    async def process(self, message: types.Message, state: FSMContext, **kwargs) -> None:
        user_id = message.from_user.id
        logger.info(f'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –∑–∞–ø—Ä–æ—Å–∏–ª —Å–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è')

        await state.finish()

        await message.answer('–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–±—Ä–æ—à–µ–Ω–æ. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:', reply_markup=TopicKeyboard())
        await UserStates.CHOOSING_TOPIC.set()

        logger.info(f'–°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} —É—Å–ø–µ—à–Ω–æ —Å–±—Ä–æ—à–µ–Ω–æ')

    def register(self, dp: Dispatcher) -> None:
        dp.register_message_handler(self.process, commands=['reset'], state='*')


class AdminUpdatePromptsHandler(BaseScenario):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–æ–≤."""

    async def process(self, message: types.Message, **kwargs) -> None:
        user_id = message.from_user.id
        logger.info(f'–ó–∞–ø—Ä–æ—Å –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–æ–≤ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}')

        if user_id not in config.ADMIN_USERS:
            logger.warning(f'–û—Ç–∫–∞–∑–∞–Ω–æ –≤ –¥–æ—Å—Ç—É–ø–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id} - –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º')
            await message.answer('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.')
            return

        await message.answer('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', reply_markup=AdminPromptKeyboard())
        await AdminStates.CHOOSING_PROMPT.set()
        logger.info(f'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –ø–µ—Ä–µ–≤–µ–¥–µ–Ω –≤ —Ä–µ–∂–∏–º –≤—ã–±–æ—Ä–∞ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è')

    def register(self, dp: Dispatcher) -> None:
        dp.register_message_handler(
            self.process,
            commands=['update_prompts'],
            state='*',
        )


class AdminChoosePromptCallback(BaseScenario):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è."""

    async def process(self, callback_query: types.CallbackQuery, state: FSMContext, **kwargs) -> None:
        user_id = callback_query.from_user.id
        prompt_callback = callback_query.data
        topic_name = prompt_callback.replace('prompt_', '')

        await callback_query.answer()

        logger.info(f'–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {user_id} –≤—ã–±—Ä–∞–ª –ø—Ä–æ–º–ø—Ç {topic_name} –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è')
        await state.update_data(chosen_prompt=topic_name)

        await callback_query.message.delete()
        prompt_type_message = await callback_query.message.answer(
            '–í—ã–±–µ—Ä–∏—Ç–µ, –∫–∞–∫–∏–µ –ø—Ä–æ–º–ø—Ç—ã –≤—ã —Ö–æ—Ç–∏—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å:',
            reply_markup=PromptTypeKeyboard(),
        )
        await state.update_data(prompt_type_message_id=prompt_type_message.message_id)
        await AdminStates.CHOOSING_PROMPT_TYPE.set()
        logger.info(f'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –ø–µ—Ä–µ–≤–µ–¥–µ–Ω –≤ —Ä–µ–∂–∏–º –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –ø—Ä–æ–º–ø—Ç–∞')

    def register(self, dp: Dispatcher) -> None:
        dp.register_callback_query_handler(
            self.process,
            lambda c: c.data.startswith('prompt_'),
            state=AdminStates.CHOOSING_PROMPT,
        )


class AdminChoosePromptTypeCallback(BaseScenario):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (—Å–∏—Å—Ç–µ–º–Ω—ã–π, –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–ª–∏ –æ–±–∞)."""

    async def process(self, callback_query: types.CallbackQuery, state: FSMContext, **kwargs) -> None:
        user_id = callback_query.from_user.id
        prompt_type = callback_query.data
        user_data = await state.get_data()
        topic_name = user_data['chosen_prompt']

        await callback_query.answer()

        logger.info(f'–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {user_id} –≤—ã–±—Ä–∞–ª —Ç–∏–ø –ø—Ä–æ–º–ø—Ç–∞ {prompt_type} –¥–ª—è —Ç–æ–ø–∏–∫–∞ {topic_name}')
        await state.update_data(chosen_prompt_type=prompt_type)

        if 'prompt_type_message_id' in user_data:
            try:
                await self.bot.delete_message(chat_id=user_id, message_id=user_data['prompt_type_message_id'])
            except Exception as e:
                logger.error(f'–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è {user_data["prompt_type_message_id"]}: {e}')

        if prompt_type == 'prompt_type_system':
            await callback_query.message.answer('–ó–∞–≥—Ä—É–∑–∏—Ç–µ TXT-—Ñ–∞–π–ª —Å –Ω–æ–≤—ã–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞:')
            await AdminStates.UPLOADING_SYSTEM_PROMPT.set()
            logger.info(f'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –ø–µ—Ä–µ–≤–µ–¥–µ–Ω –≤ —Ä–µ–∂–∏–º –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞')
        elif prompt_type == 'prompt_type_detail':
            await callback_query.message.answer('–ó–∞–≥—Ä—É–∑–∏—Ç–µ TXT-—Ñ–∞–π–ª —Å –Ω–æ–≤—ã–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞:')
            await AdminStates.UPLOADING_DETAIL_PROMPT.set()
            logger.info(f'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –ø–µ—Ä–µ–≤–µ–¥–µ–Ω –≤ —Ä–µ–∂–∏–º –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞')
        elif prompt_type == 'prompt_type_both':
            await callback_query.message.answer('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ TXT-—Ñ–∞–π–ª —Å –Ω–æ–≤—ã–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞:')
            await AdminStates.UPLOADING_SYSTEM_PROMPT.set()
            await state.update_data(upload_both_prompts=True)
            logger.info(f'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –ø–µ—Ä–µ–≤–µ–¥–µ–Ω –≤ —Ä–µ–∂–∏–º –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±–æ–∏—Ö –ø—Ä–æ–º–ø—Ç–æ–≤, –Ω–∞—á–∏–Ω–∞—è —Å —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ')

    def register(self, dp: Dispatcher) -> None:
        dp.register_callback_query_handler(
            self.process,
            lambda c: c.data.startswith('prompt_type_'),
            state=AdminStates.CHOOSING_PROMPT_TYPE,
        )


class AdminUploadSystemPromptHandler(BaseScenario):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ —Å –Ω–æ–≤—ã–º —Å–∏—Å—Ç–µ–º–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º."""

    async def process(self, message: types.Message, state: FSMContext, **kwargs) -> None:
        user_id = message.from_user.id
        user_data = await state.get_data()
        topic_name = user_data['chosen_prompt']
        upload_both = user_data.get('upload_both_prompts', False)

        logger.info(f'–ü–æ–ª—É—á–µ–Ω —Ñ–∞–π–ª –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ {topic_name} –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ {user_id}')

        if not message.document or not message.document.file_name.endswith('.txt'):
            logger.warning(
                f'–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {message.document.file_name if message.document else "–Ω–µ—Ç —Ñ–∞–π–ª–∞"}',
            )
            await message.answer('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –≤ —Ñ–æ—Ä–º–∞—Ç–µ TXT.')
            return

        try:
            file_id = message.document.file_id
            file = await self.bot.get_file(file_id)
            file_path = file.file_path
            downloaded_file = await self.bot.download_file(file_path)
            logger.debug(f'–§–∞–π–ª {message.document.file_name} —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω')

            file_content = downloaded_file.read().decode('utf-8')
            logger.debug(f'–†–∞–∑–º–µ—Ä —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞: {len(file_content)} —Å–∏–º–≤–æ–ª–æ–≤')

            system_prompts = SystemPrompts()
            system_prompts.set_prompt(SystemPrompt[topic_name.upper()], file_content)
            logger.info(f'–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç {topic_name} —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º {user_id}')

            if upload_both:
                await message.answer('–¢–µ–ø–µ—Ä—å –∑–∞–≥—Ä—É–∑–∏—Ç–µ TXT-—Ñ–∞–π–ª —Å –Ω–æ–≤—ã–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞:')
                await AdminStates.UPLOADING_DETAIL_PROMPT.set()
                logger.info(f'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –ø–µ—Ä–µ–≤–µ–¥–µ–Ω –≤ —Ä–µ–∂–∏–º –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞')
                return

            await message.answer(f"–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è —Ç–µ–º—ã '{Topics[topic_name].value}' —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!")
        except KeyError:
            logger.error(f'–û—à–∏–±–∫–∞: —Ç–µ–º–∞ {topic_name} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞')
            await message.answer(f"–û—à–∏–±–∫–∞: —Ç–µ–º–∞ '{topic_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
        except Exception as e:
            logger.error(f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞: {e}', exc_info=True)
            await message.answer(
                '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞.\n–°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É.\n'
                '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–∞–∂–∞–≤ –∫–æ–º–∞–Ω–¥—É /start',
            )
            await self.bot.send_message(
                chat_id=config.OWNER_ID,
                text=f'–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞: {e}',
            )

        await state.finish()
        await message.answer('–ß–µ–º —è –º–æ–≥—É –≤–∞–º –ø–æ–º–æ—á—å?', reply_markup=TopicKeyboard())
        await UserStates.CHOOSING_TOPIC.set()
        logger.info(f'–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {user_id} –≤–µ—Ä–Ω—É–ª—Å—è –≤ —Ä–µ–∂–∏–º –≤—ã–±–æ—Ä–∞ —Ç–µ–º—ã')

    def register(self, dp: Dispatcher) -> None:
        dp.register_message_handler(
            self.process,
            content_types=['document'],
            state=AdminStates.UPLOADING_SYSTEM_PROMPT,
        )


class AdminUploadDetailPromptHandler(BaseScenario):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ —Å –Ω–æ–≤—ã–º –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º."""

    async def process(self, message: types.Message, state: FSMContext, **kwargs) -> None:
        user_id = message.from_user.id
        user_data = await state.get_data()
        topic_name = user_data['chosen_prompt']
        detail_topic_name = f'{topic_name.upper()}_DETAIL'

        logger.info(f'–ü–æ–ª—É—á–µ–Ω —Ñ–∞–π–ª –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ {topic_name} –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ {user_id}')

        if not message.document or not message.document.file_name.endswith('.txt'):
            logger.warning(
                f'–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {message.document.file_name if message.document else "–Ω–µ—Ç —Ñ–∞–π–ª–∞"}',
            )
            await message.answer('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –≤ —Ñ–æ—Ä–º–∞—Ç–µ TXT.')
            return

        try:
            file_id = message.document.file_id
            file = await self.bot.get_file(file_id)
            file_path = file.file_path
            downloaded_file = await self.bot.download_file(file_path)
            logger.debug(f'–§–∞–π–ª {message.document.file_name} —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω')

            file_content = downloaded_file.read().decode('utf-8')
            logger.debug(f'–†–∞–∑–º–µ—Ä —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞: {len(file_content)} —Å–∏–º–≤–æ–ª–æ–≤')

            if not hasattr(SystemPrompt, detail_topic_name):
                logger.warning(f'–î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç {detail_topic_name} –Ω–µ –Ω–∞–π–¥–µ–Ω, –≤–æ–∑–º–æ–∂–Ω–æ —ç—Ç–æ –æ—à–∏–±–∫–∞')
                await message.answer(
                    '–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è —ç—Ç–æ–π —Ç–µ–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ. '
                    '–í–æ–∑–º–æ–∂–Ω–æ, –¥–ª—è –¥–∞–Ω–Ω–æ–π —Ç–µ–º—ã –µ–≥–æ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.',
                )
            else:
                system_prompts = SystemPrompts()
                system_prompts.set_prompt(SystemPrompt[detail_topic_name], file_content)
                logger.info(f'–î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç {detail_topic_name} —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º {user_id}')
                await message.answer(
                    f"–î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è —Ç–µ–º—ã '{Topics[topic_name].value}' —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!",
                )

        except KeyError:
            logger.error(f'–û—à–∏–±–∫–∞: —Ç–µ–º–∞ {topic_name} –∏–ª–∏ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç {detail_topic_name} –Ω–µ –Ω–∞–π–¥–µ–Ω')
            await message.answer(f'–û—à–∏–±–∫–∞: —Ç–µ–º–∞ –∏–ª–∏ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.')
        except Exception as e:
            logger.error(f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞: {e}', exc_info=True)
            await message.answer(
                '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–º–ø—Ç–∞.\n–°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É.\n'
                '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–∞–∂–∞–≤ –∫–æ–º–∞–Ω–¥—É /start',
            )
            await self.bot.send_message(
                chat_id=config.OWNER_ID,
                text=f'–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞: {e}',
            )

        await state.finish()
        await message.answer('–ß–µ–º —è –º–æ–≥—É –≤–∞–º –ø–æ–º–æ—á—å?', reply_markup=TopicKeyboard())
        await UserStates.CHOOSING_TOPIC.set()
        logger.info(f'–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {user_id} –≤–µ—Ä–Ω—É–ª—Å—è –≤ —Ä–µ–∂–∏–º –≤—ã–±–æ—Ä–∞ —Ç–µ–º—ã')

    def register(self, dp: Dispatcher) -> None:
        dp.register_message_handler(
            self.process,
            content_types=['document'],
            state=AdminStates.UPLOADING_DETAIL_PROMPT,
        )


class AdminUploadPromptHandler(BaseScenario):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ —Å –Ω–æ–≤—ã–º –ø—Ä–æ–º–ø—Ç–æ–º."""

    async def process(self, message: types.Message, state: FSMContext, **kwargs) -> None:
        user_id = message.from_user.id
        user_data = await state.get_data()
        topic_name = user_data['chosen_prompt']

        logger.info(
            f'–ü–æ–ª—É—á–µ–Ω —Ñ–∞–π–ª –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–º–ø—Ç–∞ {topic_name} –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ {user_id} (–æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)',
        )

        if not message.document or not message.document.file_name.endswith('.txt'):
            logger.warning(
                f'–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {message.document.file_name if message.document else "–Ω–µ—Ç —Ñ–∞–π–ª–∞"}',
            )
            await message.answer('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –≤ —Ñ–æ—Ä–º–∞—Ç–µ TXT.')
            return

        try:
            file_id = message.document.file_id
            file = await self.bot.get_file(file_id)
            file_path = file.file_path
            downloaded_file = await self.bot.download_file(file_path)
            logger.debug(f'–§–∞–π–ª {message.document.file_name} —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω')

            file_content = downloaded_file.read().decode('utf-8')
            logger.debug(f'–†–∞–∑–º–µ—Ä —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞: {len(file_content)} —Å–∏–º–≤–æ–ª–æ–≤')

            system_prompts = SystemPrompts()
            system_prompts.set_prompt(SystemPrompt[topic_name.upper()], file_content)
            logger.info(f'–ü—Ä–æ–º–ø—Ç {topic_name} —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º {user_id}')

            await message.answer(f"–ü—Ä–æ–º–ø—Ç –¥–ª—è —Ç–µ–º—ã '{Topics[topic_name].value}' —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!")

        except KeyError:
            logger.error(f'–û—à–∏–±–∫–∞: —Ç–µ–º–∞ {topic_name} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞')
            await message.answer(f"–û—à–∏–±–∫–∞: —Ç–µ–º–∞ '{topic_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
        except Exception as e:
            logger.error(f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–º–ø—Ç–∞: {e}', exc_info=True)
            await message.answer(
                '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–º–ø—Ç–∞.\n–°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É.\n'
                '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–∞–∂–∞–≤ –∫–æ–º–∞–Ω–¥—É /start',
            )
            await self.bot.send_message(
                chat_id=config.OWNER_ID,
                text=f'–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–º–ø—Ç–∞: {e}',
            )

        await state.finish()
        await message.answer('–ß–µ–º —è –º–æ–≥—É –≤–∞–º –ø–æ–º–æ—á—å?', reply_markup=TopicKeyboard())
        await UserStates.CHOOSING_TOPIC.set()
        logger.info(f'–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {user_id} –≤–µ—Ä–Ω—É–ª—Å—è –≤ —Ä–µ–∂–∏–º –≤—ã–±–æ—Ä–∞ —Ç–µ–º—ã')

    def register(self, dp: Dispatcher) -> None:
        dp.register_message_handler(
            self.process,
            content_types=['document'],
            state=AdminStates.UPLOADING_PROMPT,
        )


class AdminNewPromptHandler(BaseScenario):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Ç–æ–ø–∏–∫–∞ –∏ –ø—Ä–æ–º–ø—Ç–∞."""

    async def process(self, message: types.Message, state: FSMContext, **kwargs) -> None:
        user_id = message.from_user.id

        if user_id not in config.ADMIN_USERS:
            await message.answer('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.')
            return

        await message.answer('–®–∞–≥ 1: –í–≤–µ–¥–∏—Ç–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∏–º—è —Ç–æ–ø–∏–∫–∞ (—Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã):')
        await AdminStates.NEW_PROMPT_NAME.set()
        logger.info(f'–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {user_id} –Ω–∞—á–∞–ª –ø—Ä–æ—Ü–µ—Å—Å —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Ç–æ–ø–∏–∫–∞')

    def register(self, dp: Dispatcher) -> None:
        dp.register_message_handler(
            self.process,
            commands=['new_prompt'],
            state='*',
        )


class AdminNewPromptNameHandler(BaseScenario):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –∏–º–µ–Ω–∏ –Ω–æ–≤–æ–≥–æ —Ç–æ–ø–∏–∫–∞."""

    async def process(self, message: types.Message, state: FSMContext, **kwargs) -> None:
        user_id = message.from_user.id
        prompt_name = message.text.strip().lower()
        logger.info(f'–ü–æ–ª—É—á–µ–Ω–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∏–º—è –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ {user_id}: {prompt_name}')

        if not prompt_name.isalnum() or not prompt_name.isascii():
            logger.warning(f'–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∏–º—è –ø—Ä–æ–º–ø—Ç–∞: {prompt_name}')
            await message.answer('–ò–º—è –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑:')
            return

        if prompt_name in Topics.__members__:
            logger.warning(f'–ü—Ä–æ–º–ø—Ç —Å –∏–º–µ–Ω–µ–º {prompt_name} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç')
            await message.answer(f"–¢–æ–ø–∏–∫ —Å –∏–º–µ–Ω–µ–º '{prompt_name}' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –í–≤–µ–¥–∏—Ç–µ –¥—Ä—É–≥–æ–µ –∏–º—è:")
            return

        await state.update_data(new_prompt_name=prompt_name)
        await message.answer('–®–∞–≥ 2: –í–≤–µ–¥–∏—Ç–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–ø–∏–∫–∞ (–Ω–∞ —Ä—É—Å—Å–∫–æ–º):')
        await AdminStates.NEW_PROMPT_DISPLAY.set()
        logger.info(f'–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {user_id} –ø–µ—Ä–µ—à–µ–ª –∫ –≤–≤–æ–¥—É –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–≥–æ –∏–º–µ–Ω–∏ –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞ {prompt_name}')

    def register(self, dp: Dispatcher) -> None:
        dp.register_message_handler(
            self.process,
            content_types=['text'],
            state=AdminStates.NEW_PROMPT_NAME,
        )


class AdminNewPromptDisplayHandler(BaseScenario):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–≥–æ –∏–º–µ–Ω–∏ –Ω–æ–≤–æ–≥–æ —Ç–æ–ø–∏–∫–∞."""

    async def process(self, message: types.Message, state: FSMContext, **kwargs) -> None:
        user_id = message.from_user.id
        display_name = message.text.strip()
        user_data = await state.get_data()
        prompt_name = user_data['new_prompt_name']

        logger.info(f'–ü–æ–ª—É—á–µ–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞ {prompt_name} –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ {user_id}: {display_name}')

        if not display_name:
            logger.warning(f'–ü—É—Å—Ç–æ–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞ {prompt_name}')
            await message.answer('–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –í–≤–µ–¥–∏—Ç–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è:')
            return

        await state.update_data(new_prompt_display=display_name)

        await message.answer(
            f"–®–∞–≥ 3: –ó–∞–≥—Ä—É–∑–∏—Ç–µ TXT-—Ñ–∞–π–ª —Å —Å–∏—Å—Ç–µ–º–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º –¥–ª—è —Ç–æ–ø–∏–∫–∞ '{display_name}':",
        )
        await AdminStates.NEW_PROMPT_UPLOAD.set()
        logger.info(f'–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {user_id} –ø–µ—Ä–µ—à–µ–ª –∫ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞ –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ {prompt_name}')

    def register(self, dp: Dispatcher) -> None:
        dp.register_message_handler(
            self.process,
            content_types=['text'],
            state=AdminStates.NEW_PROMPT_DISPLAY,
        )


class AdminNewPromptUploadHandler(BaseScenario):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ —Å —Å–∏—Å—Ç–µ–º–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º."""

    async def process(self, message: types.Message, state: FSMContext, **kwargs) -> None:
        user_id = message.from_user.id
        user_data = await state.get_data()
        prompt_name = user_data['new_prompt_name']
        display_name = user_data['new_prompt_display']

        logger.info(f'–ü–æ–ª—É—á–µ–Ω —Ñ–∞–π–ª –¥–ª—è –Ω–æ–≤–æ–≥–æ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ {prompt_name} –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ {user_id}')

        if not message.document or not message.document.file_name.endswith('.txt'):
            logger.warning(
                f'–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {message.document.file_name if message.document else "–Ω–µ—Ç —Ñ–∞–π–ª–∞"}',
            )
            await message.answer('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –≤ —Ñ–æ—Ä–º–∞—Ç–µ TXT.')
            return

        file_id = message.document.file_id
        file = await self.bot.get_file(file_id)
        file_path = file.file_path
        downloaded_file = await self.bot.download_file(file_path)
        logger.debug(f'–§–∞–π–ª {message.document.file_name} —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω')

        file_content = downloaded_file.read().decode('utf-8')
        logger.debug(f'–†–∞–∑–º–µ—Ä —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞: {len(file_content)} —Å–∏–º–≤–æ–ª–æ–≤')

        try:
            await state.update_data(system_prompt_content=file_content)
            await message.answer(f"–®–∞–≥ 4: –ó–∞–≥—Ä—É–∑–∏—Ç–µ TXT-—Ñ–∞–π–ª —Å –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º –¥–ª—è —Ç–æ–ø–∏–∫–∞ '{display_name}':")
            await AdminStates.NEW_PROMPT_UPLOAD_DETAIL.set()
            logger.info(f'–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {user_id} –ø–µ—Ä–µ—à–µ–ª –∫ –∑–∞–≥—Ä—É–∑–∫–µ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è {prompt_name}')
        except Exception as e:
            logger.error(f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞: {e}', exc_info=True)
            await message.answer(
                '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞.\n–°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É.\n'
                '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–∞–∂–∞–≤ –∫–æ–º–∞–Ω–¥—É /start',
            )
            await self.bot.send_message(
                chat_id=config.OWNER_ID,
                text=f'–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞: {e}\n\n{traceback.format_exc()}',
            )
            await state.finish()

    def register(self, dp: Dispatcher) -> None:
        dp.register_message_handler(
            self.process,
            content_types=['document'],
            state=AdminStates.NEW_PROMPT_UPLOAD,
        )


class AdminNewPromptUploadDetailHandler(BaseScenario):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ —Å –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º."""

    async def process(self, message: types.Message, state: FSMContext, **kwargs) -> None:
        user_id = message.from_user.id
        user_data = await state.get_data()
        prompt_name = user_data['new_prompt_name']
        display_name = user_data['new_prompt_display']
        system_prompt_content = user_data['system_prompt_content']

        logger.info(f'–ü–æ–ª—É—á–µ–Ω —Ñ–∞–π–ª –¥–ª—è –Ω–æ–≤–æ–≥–æ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ {prompt_name} –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ {user_id}')

        if not message.document or not message.document.file_name.endswith('.txt'):
            logger.warning(
                f'–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {message.document.file_name if message.document else "–Ω–µ—Ç —Ñ–∞–π–ª–∞"}',
            )
            await message.answer('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –≤ —Ñ–æ—Ä–º–∞—Ç–µ TXT.')
            return

        file_id = message.document.file_id
        file = await self.bot.get_file(file_id)
        file_path = file.file_path
        downloaded_file = await self.bot.download_file(file_path)
        logger.debug(f'–§–∞–π–ª {message.document.file_name} —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω')

        detail_prompt_content = downloaded_file.read().decode('utf-8')
        logger.debug(f'–†–∞–∑–º–µ—Ä —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞: {len(detail_prompt_content)} —Å–∏–º–≤–æ–ª–æ–≤')

        try:
            system_prompts = SystemPrompts()
            system_prompts.add_new_prompt(prompt_name, display_name, system_prompt_content, detail_prompt_content)
            logger.info(f'–ù–æ–≤—ã–π —Ç–æ–ø–∏–∫ {prompt_name} ({display_name}) —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º {user_id}')

            await message.answer(f"–¢–æ–ø–∏–∫ '{display_name}' —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω —Å —Å–∏—Å—Ç–µ–º–Ω—ã–º –∏ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø—Ä–æ–º–ø—Ç–∞–º–∏!")

            await self.bot.send_message(
                chat_id=user_id,
                text=f"–¢–æ–ø–∏–∫ '{display_name}' —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!\n\n"
                f'–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç: {len(system_prompt_content)} —Å–∏–º–≤–æ–ª–æ–≤\n'
                f'–î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç: {len(detail_prompt_content)} —Å–∏–º–≤–æ–ª–æ–≤',
            )
        except Exception as e:
            logger.error(f'–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ —Ç–æ–ø–∏–∫–∞: {e}', exc_info=True)
            await message.answer(
                '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–æ–ø–∏–∫–∞.\n–°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É.\n'
                '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–∞–∂–∞–≤ –∫–æ–º–∞–Ω–¥—É /start',
            )
            await self.bot.send_message(
                chat_id=config.OWNER_ID,
                text=f'–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–æ–ø–∏–∫–∞: {e}\n\n{traceback.format_exc()}',
            )

        await state.finish()
        await message.answer('–ß–µ–º —è –º–æ–≥—É –≤–∞–º –ø–æ–º–æ—á—å?', reply_markup=TopicKeyboard())
        await UserStates.CHOOSING_TOPIC.set()
        logger.info(f'–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {user_id} –≤–µ—Ä–Ω—É–ª—Å—è –≤ —Ä–µ–∂–∏–º –≤—ã–±–æ—Ä–∞ —Ç–µ–º—ã')

    def register(self, dp: Dispatcher) -> None:
        dp.register_message_handler(
            self.process,
            content_types=['document'],
            state=AdminStates.NEW_PROMPT_UPLOAD_DETAIL,
        )


class AdminNewPromptTextHandler(BaseScenario):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞ –≤–º–µ—Å—Ç–æ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞."""

    async def process(self, message: types.Message, state: FSMContext, **kwargs) -> None:
        await message.answer('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ TXT-—Ñ–∞–π–ª —Å —Å–∏—Å—Ç–µ–º–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º.')

    def register(self, dp: Dispatcher) -> None:
        dp.register_message_handler(
            self.process,
            content_types=['text'],
            state=AdminStates.NEW_PROMPT_UPLOAD,
        )


class AdminUploadPromptTextHandler(BaseScenario):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞ –≤–º–µ—Å—Ç–æ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–º–ø—Ç–∞."""

    async def process(self, message: types.Message, state: FSMContext, **kwargs) -> None:
        user_id = message.from_user.id
        current_state = await state.get_state()
        logger.warning(
            f'–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {user_id} –æ—Ç–ø—Ä–∞–≤–∏–ª —Ç–µ–∫—Å—Ç –≤–º–µ—Å—Ç–æ —Ñ–∞–π–ª–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–º–ø—Ç–∞ (—Å–æ—Å—Ç–æ—è–Ω–∏–µ: {current_state})',
        )

        if current_state == 'AdminStates:UPLOADING_SYSTEM_PROMPT':
            await message.answer('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ TXT-—Ñ–∞–π–ª —Å –Ω–æ–≤—ã–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞.')
        elif current_state == 'AdminStates:UPLOADING_DETAIL_PROMPT':
            await message.answer('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ TXT-—Ñ–∞–π–ª —Å –Ω–æ–≤—ã–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞.')
        else:
            await message.answer('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ TXT-—Ñ–∞–π–ª —Å –Ω–æ–≤—ã–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º –ø—Ä–æ–º–ø—Ç–∞.')

    def register(self, dp: Dispatcher) -> None:
        dp.register_message_handler(
            self.process,
            content_types=['text'],
            state=AdminStates.UPLOADING_PROMPT,
        )
        dp.register_message_handler(
            self.process,
            content_types=['text'],
            state=AdminStates.UPLOADING_SYSTEM_PROMPT,
        )
        dp.register_message_handler(
            self.process,
            content_types=['text'],
            state=AdminStates.UPLOADING_DETAIL_PROMPT,
        )


class AdminLoadPromptsHandler(BaseScenario):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –≤—ã–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–æ–≤."""

    async def process(self, message: types.Message, **kwargs) -> None:
        user_id = message.from_user.id

        if user_id not in config.ADMIN_USERS:
            await message.answer('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.')
            return

        await message.answer('–ù–∞—á–∏–Ω–∞—é –≤—ã–≥—Ä—É–∑–∫—É –≤—Å–µ—Ö —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–æ–≤...')

        for prompt_file in DEFAULT_PROMPTS_DIR.glob('*.txt'):
            try:
                with open(prompt_file, 'rb') as f:
                    await message.answer_document(document=types.InputFile(f, filename=prompt_file.name))
            except Exception as e:
                logger.error(f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–≥—Ä—É–∑–∫–µ –ø—Ä–æ–º–ø—Ç–∞ {prompt_file.name}: {e}')
                await message.answer(f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–≥—Ä—É–∑–∫–µ –ø—Ä–æ–º–ø—Ç–∞ {prompt_file.name}')
                await self.bot.send_message(
                    chat_id=config.OWNER_ID,
                    text=f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–≥—Ä—É–∑–∫–µ –ø—Ä–æ–º–ø—Ç–∞ {prompt_file.name}.\n{e}',
                )

        await message.answer('–í—ã–≥—Ä—É–∑–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.')

    def register(self, dp: Dispatcher) -> None:
        dp.register_message_handler(self.process, commands=['load_prompts'], state='*')


class AdminUpdateScoutingExcelHandler(BaseScenario):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è excel —Ñ–∞–π–ª–∞ —Å–∫–∞—É—Ç–∏–Ω–≥–∞ —Å—Ç–∞—Ä—Ç–∞–ø–æ–≤."""

    async def process(self, message: types.Message, **kwargs) -> Any:
        user_id = message.from_user.id
        if user_id not in config.ADMIN_USERS:
            logger.warning(f'–û—Ç–∫–∞–∑–∞–Ω–æ –≤ –¥–æ—Å—Ç—É–ø–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id} - –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º')
            await message.answer('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.')
            return

        await message.answer('–û—Ç–ø—Ä–∞–≤—å—Ç–µ Excel(.xlsx) —Ñ–∞–π–ª –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.')
        await AdminStates.UPLOADING_SCOUTING_FILE.set()
        logger.info(f'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –ø–µ—Ä–µ–≤–µ–¥–µ–Ω –≤ —Ä–µ–∂–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞ —Å–∫–∞—É—Ç–∏–Ω–≥–∞.')

    def register(self, dp: Dispatcher) -> None:
        dp.register_message_handler(
            self.process,
            commands=['update_scouting_prompts'],
            state='*',
        )


class AdminUploadScoutingExcelFileHandler(BaseScenario):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ —Å –Ω–æ–≤—ã–º excel —Ñ–∞–π–ª–æ–º –¥–ª—è —Å–∫–∞—É—Ç–∏–Ω–≥–∞."""

    async def process(self, message: types.Message, state: FSMContext, **kwargs) -> Any:
        user_id = message.from_user.id

        logger.info(f'–ü–æ–ª—É—á–µ–Ω —Ñ–∞–π–ª –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è excel —Ñ–∞–π–ª–∞ –¥–ª—è —Å–∫–∞—É—Ç–∏–Ω–≥–∞ –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ {user_id}')

        if not message.document or not message.document.file_name.endswith('.xlsx'):
            logger.warning(
                f'–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {message.document.file_name if message.document else "–Ω–µ—Ç —Ñ–∞–π–ª–∞"}'
            )
            await message.answer('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –≤ —Ñ–æ—Ä–º–∞—Ç–µ XLSX.')
            return

        try:
            file_id = message.document.file_id
            file = await self.bot.get_file(file_id)
            file_path = file.file_path
            downloaded_file = await self.bot.download_file(file_path)
            logger.debug(f'–§–∞–π–ª {message.document.file_name} —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω')

            file_content = downloaded_file.read()
            logger.debug(f'–†–∞–∑–º–µ—Ä —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ excel —Ñ–∞–π–ª–∞: {len(file_content)} —Å–∏–º–≤–æ–ª–æ–≤')

            await self.bot.send_chat_action(chat_id=user_id, action='upload_document')

            file_manager = ExcelFileManager()
            await file_manager.update_excel_file(file_content)
            logger.info(f'Excel —Ñ–∞–π–ª —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º {user_id}')

            await file_manager.delete_file()
            await file_manager.upload_file()

            await message.answer('–§–∞–π–ª –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–∞—Ö OpenAI, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ –æ–∂–∏–¥–∞–π—Ç–µ')
            is_file_updated = await file_manager.check_status_file()
            if not is_file_updated:
                await message.answer('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ñ–∞–π–ª. –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É.')

            logger.info('Excel —Ñ–∞–π–ª —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω –≤ OpenAI')
            await message.answer('Excel —Ñ–∞–π–ª —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é.')

        except Exception as e:
            logger.error(f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ excel —Ñ–∞–π–ª–∞ –¥–ª—è —Å–∫–∞—É—Ç–∏–Ω–≥–∞: {e}', exc_info=True)
            await message.answer(
                '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ excel —Ñ–∞–π–ª–∞ –¥–ª—è —Å–∫–∞—É—Ç–∏–Ω–≥–∞.\n–°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É.\n'
                '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–∞–∂–∞–≤ –∫–æ–º–∞–Ω–¥—É /start',
            )
            await self.bot.send_message(
                chat_id=config.OWNER_ID,
                text=f'–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ excel —Ñ–∞–π–ª–∞ –¥–ª—è —Å–∫–∞—É—Ç–∏–Ω–≥–∞: {e}',
            )

        await state.finish()
        await message.answer('–ß–µ–º —è –º–æ–≥—É –≤–∞–º –ø–æ–º–æ—á—å?', reply_markup=TopicKeyboard())
        await UserStates.CHOOSING_TOPIC.set()
        logger.info(f'–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {user_id} –≤–µ—Ä–Ω—É–ª—Å—è –≤ —Ä–µ–∂–∏–º –≤—ã–±–æ—Ä–∞ —Ç–µ–º—ã')

    def register(self, dp: Dispatcher) -> None:
        dp.register_message_handler(
            self.process,
            content_types=['document'],
            state=AdminStates.UPLOADING_SCOUTING_FILE,
        )


class AdminHelpHandler(BaseScenario):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /help –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞."""

    async def process(self, message: types.Message, **kwargs) -> None:
        user_id = message.from_user.id

        if user_id not in config.ADMIN_USERS:
            await message.answer('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.')
            return

        help_text = (
            'üîë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n\n'
            '/update_prompts - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞. –ü–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–±—Ä–∞—Ç—å —Ç–µ–º—É, '
            '—Ç–∏–ø –ø—Ä–æ–º–ø—Ç–∞ (—Å–∏—Å—Ç–µ–º–Ω—ã–π, –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–ª–∏ –æ–±–∞) –∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å '
            'TXT-—Ñ–∞–π–ª(—ã) —Å –Ω–æ–≤—ã–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º.\n\n'
            '/new_prompt - –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–æ–ø–∏–∫–∞ –∏ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞. –ü—Ä–æ–≤–µ–¥–µ—Ç —á–µ—Ä–µ–∑ –ø—Ä–æ—Ü–µ—Å—Å —Å–æ–∑–¥–∞–Ω–∏—è '
            '–Ω–æ–≤–æ–≥–æ —Ç–æ–ø–∏–∫–∞ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –∏–º–µ–Ω–∏, –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏—è –∏ –∑–∞–≥—Ä—É–∑–∫–æ–π —Ñ–∞–π–ª–∞ –ø—Ä–æ–º–ø—Ç–∞.\n\n'
            '/load_prompts - –í—ã–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–æ–≤ –≤ –≤–∏–¥–µ TXT-—Ñ–∞–π–ª–æ–≤ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.\n\n'
            '/update_scouting_prompts - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ excel —Ñ–∞–π–ª–∞ –¥–ª—è —Ç–µ–º—ã "–°–∫–∞—É—Ç–∏–Ω–≥ —Å—Ç–∞—Ä—Ç–∞–ø–æ–≤"\n\n'
            '/list_auth_users - –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ id –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.\n\n'
            '/start - –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞ –∏ –≤–æ–∑–≤—Ä–∞—Ç –∫ –≤—ã–±–æ—Ä—É —Ç–µ–º—ã –∞–Ω–∞–ª–∏–∑–∞.'
        )

        await message.answer(help_text)

    def register(self, dp: Dispatcher) -> None:
        dp.register_message_handler(self.process, commands=['help'], state='*')


class AdminListAuthUsersHandler(BaseScenario):
    async def process(self, message: types.Message, **kwargs) -> None:
        user_id = message.from_user.id

        if user_id not in config.ADMIN_USERS:
            await message.answer('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.')
            return

        auth_user_list = ', '.join([str(i) for i in config.AUTHORIZED_USERS_IDS])
        await message.answer(auth_user_list)

    def register(self, dp: Dispatcher) -> None:
        dp.register_message_handler(self.process, commands=['list_auth_users'], state='*')


class BotManager:
    scenarios: Dict[str, BaseScenario] = {}

    main_scenario = {
        'access': Access,
        'start': StartHandler,
        'choose_topic': ProcessingChooseTopicCallback,
        'enter_prompt': ProcessingEnterPromptHandler,
        'attach_file': AttachFileHandler,
        'upload_file': UploadFileHandler,
        'continue_dialog': ContinueDialogHandler,
        'continue_callback': ProcessingContinueCallback,
        'reset_state': ResetStateHandler,
    }

    admins_update_system_prompts_scenario = {
        'update_prompts': AdminUpdatePromptsHandler,
        'choose_prompt': AdminChoosePromptCallback,
        'choose_prompt_type': AdminChoosePromptTypeCallback,
        'upload_system_prompt': AdminUploadSystemPromptHandler,
        'upload_detail_prompt': AdminUploadDetailPromptHandler,
        'upload_prompt': AdminUploadPromptHandler,
        'upload_prompt_text': AdminUploadPromptTextHandler,
    }

    admin_new_system_prompts_scenario = {
        'new_prompt': AdminNewPromptHandler,
        'new_prompt_name': AdminNewPromptNameHandler,
        'new_prompt_display': AdminNewPromptDisplayHandler,
        'new_prompt_upload': AdminNewPromptUploadHandler,
        'new_prompt_upload_detail': AdminNewPromptUploadDetailHandler,
        'new_prompt_text': AdminNewPromptTextHandler,
        'load_prompts': AdminLoadPromptsHandler,
    }

    admin_update_scouting_excel = {
        'update_scouting_excel': AdminUpdateScoutingExcelHandler,
        'upload_scouting_excel': AdminUploadScoutingExcelFileHandler,
    }

    admin_common_scenario = {
        'help': AdminHelpHandler,
        'auth_users_list': AdminListAuthUsersHandler,
    }

    def __init__(self, bot: Bot, dp: Dispatcher) -> None:
        self.bot = bot
        self.dp = dp

        # –í–ê–ñ–ù–û: –°–æ–∑–¥–∞–µ–º investment_analysis_scenario –ü–ï–†–ï–î —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π
        self.investment_analysis_scenario = { 
            'investment_actions': InvestmentActionsHandler,    
            'investment_qa': InvestmentQAHandler, 
            'back_to_investment_actions': BackToInvestmentActionsHandler, 
            'investment_report': InvestmentReportHandler, 
            'email_input': EmailInputHandler, 
        } 
        logger.info(f"Investment analysis scenario created: {list(self.investment_analysis_scenario.keys())}") 

        self._setup_middlewares()

        # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –≤—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
        all_scenarios = [
            ('main', self.main_scenario),
            ('investment', self.investment_analysis_scenario),  # –ü–ï–†–ï–ú–ï–©–ï–ù–û –í–í–ï–†–•
            ('admin_update', self.admins_update_system_prompts_scenario),
            ('admin_new', self.admin_new_system_prompts_scenario),
            ('admin_scouting', self.admin_update_scouting_excel),
            ('admin_common', self.admin_common_scenario),
        ]

        # –°–æ–∑–¥–∞–µ–º –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –≤—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏
        for scenario_group, scenarios in all_scenarios:
            for scenario_name, scenario_class in scenarios.items():
                full_name = f'{scenario_group}_{scenario_name}'
                logger.info(f'Registering scenario: {full_name}')
                scenario_instance = scenario_class(bot)
                self._register_scenario(full_name, scenario_instance)

        # –í–ê–ñ–ù–û: –í—ã–∑—ã–≤–∞–µ–º register() –¥–ª—è –í–°–ï–• —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –ø–æ—Å–ª–µ –∏—Ö —Å–æ–∑–¥–∞–Ω–∏—è
        logger.info("Starting registration of all handlers...")
        for scenario_name, scenario in self.scenarios.items():
            logger.info(f'Calling register() for scenario: {scenario_name}')
            try:
                scenario.register(dp)
                logger.info(f'Successfully registered: {scenario_name}')
            except Exception as e:
                logger.error(f'Failed to register {scenario_name}: {e}')

        logger.info(f"Total scenarios registered: {len(self.scenarios)}")

    def _register_scenario(self, name: str, scenario: BaseScenario) -> None:
        self.scenarios[name] = scenario
        logger.info(f'Scenario {name} added to scenarios dict')

    def _setup_middlewares(self) -> None:
        self.dp.middleware.setup(AccessMiddleware())


if __name__ == '__main__':
    config = Config()
    bot = Bot(token=config.TOKEN)
    dp = Dispatcher(bot, storage=MemoryStorage())

    BotManager(bot, dp)

    executor.start_polling(dp, skip_updates=True)


